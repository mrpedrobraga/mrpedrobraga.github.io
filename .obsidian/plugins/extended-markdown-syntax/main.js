/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var Ct=Object.defineProperty;var en=Object.getOwnPropertyDescriptor;var tn=Object.getOwnPropertyNames;var on=Object.prototype.hasOwnProperty;var rn=(r,e,t)=>e in r?Ct(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var nn=(r,e)=>{for(var t in e)Ct(r,t,{get:e[t],enumerable:!0})},sn=(r,e,t,o)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of tn(e))!on.call(r,i)&&i!==t&&Ct(r,i,{get:()=>e[i],enumerable:!(o=en(e,i))||o.enumerable});return r};var an=r=>sn(Ct({},"__esModule",{value:!0}),r);var u=(r,e,t)=>rn(r,typeof e!="symbol"?e+"":e,t);var Bn={};nn(Bn,{default:()=>bo});module.exports=an(Bn);var To=require("obsidian");var T={1:{char:"+",length:2,exactLen:!0,allowSpace:!0,mustBeClosed:!0,class:"ins",getEl:()=>document.createElement("ins"),builtin:!1},2:{char:"|",length:2,exactLen:!0,allowSpace:!0,mustBeClosed:!0,class:"spoiler",getEl:()=>{let r=document.createElement("span");return r.addClass("spoiler"),r.addEventListener("click",e=>{let t=e.currentTarget,o=!t.hasClass("spoiler-revealed");t.toggleClass("spoiler-revealed",o)}),r},builtin:!1},3:{char:"^",length:1,exactLen:!0,allowSpace:!1,mustBeClosed:!0,class:"sup",getEl:()=>document.createElement("sup"),builtin:!1},4:{char:"~",length:1,exactLen:!0,allowSpace:!1,mustBeClosed:!0,class:"sub",getEl:()=>document.createElement("sub"),builtin:!1},5:{char:"=",length:2,exactLen:!1,allowSpace:!0,mustBeClosed:!1,class:"custom-highlight",getEl:()=>document.createElement("mark"),builtin:!0},6:{char:"!",length:2,exactLen:!0,allowSpace:!0,mustBeClosed:!0,class:"custom-span",getEl(){let r=document.createElement("span");return r.classList.add(T[6].class),r},builtin:!1}};var z={7:{char:":",length:3,exactLen:!1,class:"fenced-div"}};var B={ALL:(()=>{let r=[];for(let e in T)r.push(parseInt(e));for(let e in z)r.push(parseInt(e));return r})(),ALL_BLOCK:(()=>{let r=[];for(let e in z)r.push(parseInt(e));return r})(),ALL_INLINE:(()=>{let r=[];for(let e in T)r.push(parseInt(e));return r})(),SPACE_RESTRICTED_INLINE:(()=>{let r=[];for(let e in T){let t=Number.parseInt(e);T[t].allowSpace||r.push(t)}return r})(),SPACE_ALLOWED_INLINE:(()=>{let r=[];for(let e in T){let t=Number.parseInt(e);T[t].allowSpace&&r.push(t)}return r})(),NON_BUILTIN_INLINE:(()=>{let r=[];for(let e in T){let t=Number.parseInt(e);T[t].builtin||r.push(t)}return r})()};var gr=["internal-link","external-link","math","internal-embed","list-bullet","collapse-indicator"];var $={};function Sr(r,e){for(let t of e)if(r.classList.contains(t))return!0;return!1}function Co(r){return r==" "||r==`
`||r=="	"}var et=class r{constructor(e,t){u(this,"root");u(this,"walker");u(this,"offset",0);u(this,"curNode");u(this,"nodeChanged",!1);u(this,"stack",[]);u(this,"queue",{});u(this,"parsingQueue");this.root=e,this.walker=document.createTreeWalker(e,NodeFilter.SHOW_TEXT|NodeFilter.SHOW_ELEMENT),this.walker.nextNode(),this.curNode=this.walker.currentNode,this.parsingQueue=t}streamParse(){do this.curNode instanceof Text?(this.offset=0,this.parseTextNode()):this.curNode instanceof Element&&(this.isSkipped(this.curNode)?(this.resolve(3),this.resolve(4)):this.curNode.textContent&&(this.parsingQueue.push(new r(this.curNode,this.parsingQueue)),/\s/.test(this.curNode.textContent)&&(this.resolve(3),this.resolve(4))));while(this.nextNode());this.forceResolveAll()}parseTextNode(){var t;let e=(t=this.curNode.textContent)!=null?t:"";for(;!this.nodeChanged&&this.offset<e.length;){let o=e[this.offset],i=$[o];if(o==" "||o==`
`||o=="	"){this.resolve(3),this.resolve(4),this.offset++;continue}if(!i||i==5){this.offset++;continue}this.tokenize(i)}this.nodeChanged=!1}finalize(e,t,o,i){let n=T[e].getEl();i.deleteContents(),o.surroundContents(n),t.deleteContents(),n==this.curNode.nextSibling?this.nextNode():this.prevNode(),this.nodeChanged=!0}resolve(e,t){if(t&&this.queue[e]){let o=new Range,i=this.queue[e];o.setStart(i.endContainer,i.endOffset),o.setEnd(t.startContainer,t.startOffset),this.stack.findLast((n,a)=>{if(delete this.queue[n],n==e)return this.stack.splice(a),!0}),this.finalize(e,i,o,t)}else delete this.queue[e],this.stack=this.stack.filter(o=>o!=e)}forceResolveAll(){for(let e=0;e<B.ALL_INLINE.length;e++)this.resolve(B.ALL_INLINE[e])}tokenize(e){let{length:t,char:o}=T[e],i=this.curNode.textContent,n=0,a=!!this.queue[e],s=Co(i[this.offset-1]),l;for(;i[this.offset]==o;)this.offset++,n++;if(l=Co(i[this.offset]),a&&s||!a&&l||n!=t)return!1;let f=new Range;return f.setStart(this.curNode,this.offset-n),f.setEnd(this.curNode,this.offset),this.pushDelim(e,f),!0}pushDelim(e,t){this.queue[e]?this.resolve(e,t):(this.queue[e]=t,this.stack.push(e))}nextNode(){return this.walker.nextSibling()?(this.curNode=this.walker.currentNode,!0):!1}prevNode(){return this.walker.previousSibling()?(this.curNode=this.walker.currentNode,!0):!1}isSkipped(e){return Sr(e,gr)||e.tagName=="CODE"||e.tagName=="IMG"}};var vr=/^\{([a-z0-9-]+)\}/i,br=/^\{([a-z0-9 -]+)\}/i,Eo=/:{3,}(?=([a-z0-9 -]+))\1$/yi;function Ie(r){return r.trim().replaceAll(/\s{2,}/g," ")}function Tr(r){return JSON.parse(JSON.stringify(r))}var Et=class{constructor(e){u(this,"settings");this.settings=e}decorate(e){let t=T[6].class;e.querySelectorAll("."+t).forEach(i=>{var a;if(!(i.firstChild instanceof Text&&i.firstChild.textContent))return;let n=(a=br.exec(i.firstChild.textContent))==null?void 0:a[1];if(n){let s=Ie(n).split(" ");if(i.classList.add(...s),this.settings.showSpanTagInPreviewMode)return;let l=0,f=l+n.length+2;i.firstChild.replaceData(l,f-l,"")}})}};var It=class{constructor(e){u(this,"settings");this.settings=e}decorate(e){let t=e.querySelectorAll("mark"),o=T[5].class;t.forEach(i=>{var a;if(!(i.firstChild instanceof Text&&i.firstChild.textContent))return;let n=(a=vr.exec(i.firstChild.textContent))==null?void 0:a[1];if(n){if(i.classList.add(o,`${o}-${n}`),this.settings.showHlTagInPreviewMode)return;let s=0,l=s+n.length+2;i.firstChild.replaceData(s,l-s,"")}})}};var wt=class{constructor(e){u(this,"settings");this.settings=e}decorate(e){var a;if(!(e.firstChild instanceof Text&&e.firstChild.textContent))return;Eo.lastIndex=0;let t=z[7].class,o=e.firstChild,i=e.querySelector("br"),n=Eo.exec((a=o.textContent)!=null?a:"");if(n){let s=n[1],l=Ie(s).split(" ");if(e.addClass(t,...l),this.settings.alwaysShowFencedDivTag&1)return;e.removeChild(o),i&&e.removeChild(i)}}};var xt=class{constructor(e){u(this,"query","p, h1, h2, h3, h4, h5, h6, td, th, li:not(:has(p)), .callout-title-inner");u(this,"customHighlight");u(this,"customSpan");u(this,"fencedDiv");u(this,"settings");u(this,"postProcess",e=>{if(e.classList.contains("markdown-preview-view")){if(!this.settings.decoratePDF)return;let o=e.querySelectorAll("&>div");for(let i=0;i<o.length;i++)this.decorate(o[i])}else this.decorate(e)});this.settings=e,this.customHighlight=new It(e),this.customSpan=new Et(e),this.fencedDiv=new wt(e)}parseInline(e){let t=e.querySelectorAll(this.query),o=[];if(e.classList.contains("table-cell-wrapper")){new et(e,o).streamParse();for(let i=0;i<o.length;i++)if(o[i].streamParse(),i>=100)throw Error(`${o}`);return}for(let i=0;i<t.length;i++){new et(t[i],o).streamParse();for(let n=0;n<o.length;n++)if(o[n].streamParse(),n>=100)throw Error(`${o}`);o.splice(0)}}isTargeted(e){let t=e.firstElementChild;return!!(e.classList.contains("table-cell-wrapper")||t&&(t instanceof HTMLParagraphElement||t instanceof HTMLTableElement||t instanceof HTMLUListElement||t instanceof HTMLOListElement||t.tagName=="BLOCKQUOTE"||t.classList.contains("callout")))}decorate(e){this.settings.customHighlight&1&&this.customHighlight.decorate(e),this.settings.fencedDiv&1&&e.firstElementChild instanceof HTMLParagraphElement&&this.fencedDiv.decorate(e.firstElementChild),this.isTargeted(e)&&this.parseInline(e),this.settings.customSpan&1&&this.customSpan.decorate(e)}};function Ne(r){let e=`.cm-custom-highlight-${r.tag}, .markdown-rendered mark.custom-highlight-${r.tag}, .ems-menu-item.ems-highlight-${r.tag}>.menu-item-title`,t="background-color",o=r.color;return`${e}{${t}:color(from ${o} srgb r g b/var(--hl-opacity));}`}function Cr(r){var e;return(e=document.body.computedStyleMap().get(`--color-${r}`))==null?void 0:e.toString()}function yt(){var e;let r=[];for(let t=0;t<Io.length;t++){let o=Io[t],i=o[0].toUpperCase()+o.slice(1),n=(e=Cr(o))!=null?e:"#ffffff";r.push({tag:o,name:i,color:n,showInMenu:!0})}return r}function Er(r,e,t,o=!0){return{tag:r,color:e,name:t,showInMenu:o}}var Io=["red","orange","yellow","green","cyan","blue","purple","pink"];var wr={insertion:3,spoiler:3,superscript:3,subscript:3,customHighlight:3,customSpan:3,fencedDiv:3,tidyFormatting:!0,openTagMenuAfterFormat:!0,hlTagDisplayBehaviour:2,spanTagDisplayBehaviour:2,showHlTagInPreviewMode:!1,showSpanTagInPreviewMode:!1,alwaysShowFencedDivTag:0,colorButton:!0,showAccentColor:!0,showDefaultColor:!0,showRemoveColor:!0,lightModeHlOpacity:.4,darkModeHlOpacity:.5,colorConfigs:yt(),showDefaultSpanTag:!0,showRemoveSpanTag:!0,predefinedSpanTag:[{name:"",tag:"",showInMenu:!0}],showDefaultDivTag:!0,showRemoveDivTag:!0,predefinedDivTag:[{name:"",tag:"",showInMenu:!0}],editorEscape:!1,decoratePDF:!0};function xr(r,e){var t=Object.keys(r);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(r);e&&(o=o.filter(function(i){return Object.getOwnPropertyDescriptor(r,i).enumerable})),t.push.apply(t,o)}return t}function oe(r){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?xr(Object(t),!0).forEach(function(o){ln(r,o,t[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(t)):xr(Object(t)).forEach(function(o){Object.defineProperty(r,o,Object.getOwnPropertyDescriptor(t,o))})}return r}function Lt(r){"@babel/helpers - typeof";return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?Lt=function(e){return typeof e}:Lt=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Lt(r)}function ln(r,e,t){return e in r?Object.defineProperty(r,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):r[e]=t,r}function se(){return se=Object.assign||function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(r[o]=t[o])}return r},se.apply(this,arguments)}function fn(r,e){if(r==null)return{};var t={},o=Object.keys(r),i,n;for(n=0;n<o.length;n++)i=o[n],!(e.indexOf(i)>=0)&&(t[i]=r[i]);return t}function un(r,e){if(r==null)return{};var t=fn(r,e),o,i;if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(r);for(i=0;i<n.length;i++)o=n[i],!(e.indexOf(o)>=0)&&Object.prototype.propertyIsEnumerable.call(r,o)&&(t[o]=r[o])}return t}var cn="1.15.6";function ne(r){if(typeof window!="undefined"&&window.navigator)return!!navigator.userAgent.match(r)}var ae=ne(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i),ft=ne(/Edge/i),yr=ne(/firefox/i),it=ne(/safari/i)&&!ne(/chrome/i)&&!ne(/android/i),Fo=ne(/iP(ad|od|hone)/i),Mr=ne(/chrome/i)&&ne(/android/i),_r={capture:!1,passive:!1};function E(r,e,t){r.addEventListener(e,t,!ae&&_r)}function C(r,e,t){r.removeEventListener(e,t,!ae&&_r)}function At(r,e){if(e){if(e[0]===">"&&(e=e.substring(1)),r)try{if(r.matches)return r.matches(e);if(r.msMatchesSelector)return r.msMatchesSelector(e);if(r.webkitMatchesSelector)return r.webkitMatchesSelector(e)}catch(t){return!1}return!1}}function Ar(r){return r.host&&r!==document&&r.host.nodeType?r.host:r.parentNode}function Z(r,e,t,o){if(r){t=t||document;do{if(e!=null&&(e[0]===">"?r.parentNode===t&&At(r,e):At(r,e))||o&&r===t)return r;if(r===t)break}while(r=Ar(r))}return null}var kr=/\s+/g;function V(r,e,t){if(r&&e)if(r.classList)r.classList[t?"add":"remove"](e);else{var o=(" "+r.className+" ").replace(kr," ").replace(" "+e+" "," ");r.className=(o+(t?" "+e:"")).replace(kr," ")}}function g(r,e,t){var o=r&&r.style;if(o){if(t===void 0)return document.defaultView&&document.defaultView.getComputedStyle?t=document.defaultView.getComputedStyle(r,""):r.currentStyle&&(t=r.currentStyle),e===void 0?t:t[e];!(e in o)&&e.indexOf("webkit")===-1&&(e="-webkit-"+e),o[e]=t+(typeof t=="string"?"":"px")}}function He(r,e){var t="";if(typeof r=="string")t=r;else do{var o=g(r,"transform");o&&o!=="none"&&(t=o+" "+t)}while(!e&&(r=r.parentNode));var i=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return i&&new i(t)}function Fr(r,e,t){if(r){var o=r.getElementsByTagName(e),i=0,n=o.length;if(t)for(;i<n;i++)t(o[i],i);return o}return[]}function te(){var r=document.scrollingElement;return r||document.documentElement}function O(r,e,t,o,i){if(!(!r.getBoundingClientRect&&r!==window)){var n,a,s,l,f,c,m;if(r!==window&&r.parentNode&&r!==te()?(n=r.getBoundingClientRect(),a=n.top,s=n.left,l=n.bottom,f=n.right,c=n.height,m=n.width):(a=0,s=0,l=window.innerHeight,f=window.innerWidth,c=window.innerHeight,m=window.innerWidth),(e||t)&&r!==window&&(i=i||r.parentNode,!ae))do if(i&&i.getBoundingClientRect&&(g(i,"transform")!=="none"||t&&g(i,"position")!=="static")){var d=i.getBoundingClientRect();a-=d.top+parseInt(g(i,"border-top-width")),s-=d.left+parseInt(g(i,"border-left-width")),l=a+n.height,f=s+n.width;break}while(i=i.parentNode);if(o&&r!==window){var p=He(i||r),b=p&&p.a,I=p&&p.d;p&&(a/=I,s/=b,m/=b,c/=I,l=a+c,f=s+m)}return{top:a,left:s,bottom:l,right:f,width:m,height:c}}}function Dr(r,e,t){for(var o=de(r,!0),i=O(r)[e];o;){var n=O(o)[t],a=void 0;if(t==="top"||t==="left"?a=i>=n:a=i<=n,!a)return o;if(o===te())break;o=de(o,!1)}return!1}function Ge(r,e,t,o){for(var i=0,n=0,a=r.children;n<a.length;){if(a[n].style.display!=="none"&&a[n]!==S.ghost&&(o||a[n]!==S.dragged)&&Z(a[n],t.draggable,r,!1)){if(i===e)return a[n];i++}n++}return null}function Ho(r,e){for(var t=r.lastElementChild;t&&(t===S.ghost||g(t,"display")==="none"||e&&!At(t,e));)t=t.previousElementSibling;return t||null}function W(r,e){var t=0;if(!r||!r.parentNode)return-1;for(;r=r.previousElementSibling;)r.nodeName.toUpperCase()!=="TEMPLATE"&&r!==S.clone&&(!e||At(r,e))&&t++;return t}function Or(r){var e=0,t=0,o=te();if(r)do{var i=He(r),n=i.a,a=i.d;e+=r.scrollLeft*n,t+=r.scrollTop*a}while(r!==o&&(r=r.parentNode));return[e,t]}function mn(r,e){for(var t in r)if(r.hasOwnProperty(t)){for(var o in e)if(e.hasOwnProperty(o)&&e[o]===r[t][o])return Number(t)}return-1}function de(r,e){if(!r||!r.getBoundingClientRect)return te();var t=r,o=!1;do if(t.clientWidth<t.scrollWidth||t.clientHeight<t.scrollHeight){var i=g(t);if(t.clientWidth<t.scrollWidth&&(i.overflowX=="auto"||i.overflowX=="scroll")||t.clientHeight<t.scrollHeight&&(i.overflowY=="auto"||i.overflowY=="scroll")){if(!t.getBoundingClientRect||t===document.body)return te();if(o||e)return t;o=!0}}while(t=t.parentNode);return te()}function hn(r,e){if(r&&e)for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}function wo(r,e){return Math.round(r.top)===Math.round(e.top)&&Math.round(r.left)===Math.round(e.left)&&Math.round(r.height)===Math.round(e.height)&&Math.round(r.width)===Math.round(e.width)}var nt;function Hr(r,e){return function(){if(!nt){var t=arguments,o=this;t.length===1?r.call(o,t[0]):r.apply(o,t),nt=setTimeout(function(){nt=void 0},e)}}}function dn(){clearTimeout(nt),nt=void 0}function Gr(r,e,t){r.scrollLeft+=e,r.scrollTop+=t}function Br(r){var e=window.Polymer,t=window.jQuery||window.Zepto;return e&&e.dom?e.dom(r).cloneNode(!0):t?t(r).clone(!0)[0]:r.cloneNode(!0)}function Vr(r,e,t){var o={};return Array.from(r.children).forEach(function(i){var n,a,s,l;if(!(!Z(i,e.draggable,r,!1)||i.animated||i===t)){var f=O(i);o.left=Math.min((n=o.left)!==null&&n!==void 0?n:1/0,f.left),o.top=Math.min((a=o.top)!==null&&a!==void 0?a:1/0,f.top),o.right=Math.max((s=o.right)!==null&&s!==void 0?s:-1/0,f.right),o.bottom=Math.max((l=o.bottom)!==null&&l!==void 0?l:-1/0,f.bottom)}}),o.width=o.right-o.left,o.height=o.bottom-o.top,o.x=o.left,o.y=o.top,o}var F="Sortable"+new Date().getTime();function pn(){var r=[],e;return{captureAnimationState:function(){if(r=[],!!this.options.animation){var o=[].slice.call(this.el.children);o.forEach(function(i){if(!(g(i,"display")==="none"||i===S.ghost)){r.push({target:i,rect:O(i)});var n=oe({},r[r.length-1].rect);if(i.thisAnimationDuration){var a=He(i,!0);a&&(n.top-=a.f,n.left-=a.e)}i.fromRect=n}})}},addAnimationState:function(o){r.push(o)},removeAnimationState:function(o){r.splice(mn(r,{target:o}),1)},animateAll:function(o){var i=this;if(!this.options.animation){clearTimeout(e),typeof o=="function"&&o();return}var n=!1,a=0;r.forEach(function(s){var l=0,f=s.target,c=f.fromRect,m=O(f),d=f.prevFromRect,p=f.prevToRect,b=s.rect,I=He(f,!0);I&&(m.top-=I.f,m.left-=I.e),f.toRect=m,f.thisAnimationDuration&&wo(d,m)&&!wo(c,m)&&(b.top-m.top)/(b.left-m.left)===(c.top-m.top)/(c.left-m.left)&&(l=Sn(b,d,p,i.options)),wo(m,c)||(f.prevFromRect=c,f.prevToRect=m,l||(l=i.options.animation),i.animate(f,b,m,l)),l&&(n=!0,a=Math.max(a,l),clearTimeout(f.animationResetTimer),f.animationResetTimer=setTimeout(function(){f.animationTime=0,f.prevFromRect=null,f.fromRect=null,f.prevToRect=null,f.thisAnimationDuration=null},l),f.thisAnimationDuration=l)}),clearTimeout(e),n?e=setTimeout(function(){typeof o=="function"&&o()},a):typeof o=="function"&&o(),r=[]},animate:function(o,i,n,a){if(a){g(o,"transition",""),g(o,"transform","");var s=He(this.el),l=s&&s.a,f=s&&s.d,c=(i.left-n.left)/(l||1),m=(i.top-n.top)/(f||1);o.animatingX=!!c,o.animatingY=!!m,g(o,"transform","translate3d("+c+"px,"+m+"px,0)"),this.forRepaintDummy=gn(o),g(o,"transition","transform "+a+"ms"+(this.options.easing?" "+this.options.easing:"")),g(o,"transform","translate3d(0,0,0)"),typeof o.animated=="number"&&clearTimeout(o.animated),o.animated=setTimeout(function(){g(o,"transition",""),g(o,"transform",""),o.animated=!1,o.animatingX=!1,o.animatingY=!1},a)}}}}function gn(r){return r.offsetWidth}function Sn(r,e,t,o){return Math.sqrt(Math.pow(e.top-r.top,2)+Math.pow(e.left-r.left,2))/Math.sqrt(Math.pow(e.top-t.top,2)+Math.pow(e.left-t.left,2))*o.animation}var Me=[],xo={initializeByDefault:!0},ut={mount:function(e){for(var t in xo)xo.hasOwnProperty(t)&&!(t in e)&&(e[t]=xo[t]);Me.forEach(function(o){if(o.pluginName===e.pluginName)throw"Sortable: Cannot mount plugin ".concat(e.pluginName," more than once")}),Me.push(e)},pluginEvent:function(e,t,o){var i=this;this.eventCanceled=!1,o.cancel=function(){i.eventCanceled=!0};var n=e+"Global";Me.forEach(function(a){t[a.pluginName]&&(t[a.pluginName][n]&&t[a.pluginName][n](oe({sortable:t},o)),t.options[a.pluginName]&&t[a.pluginName][e]&&t[a.pluginName][e](oe({sortable:t},o)))})},initializePlugins:function(e,t,o,i){Me.forEach(function(s){var l=s.pluginName;if(!(!e.options[l]&&!s.initializeByDefault)){var f=new s(e,t,e.options);f.sortable=e,f.options=e.options,e[l]=f,se(o,f.defaults)}});for(var n in e.options)if(e.options.hasOwnProperty(n)){var a=this.modifyOption(e,n,e.options[n]);typeof a!="undefined"&&(e.options[n]=a)}},getEventProperties:function(e,t){var o={};return Me.forEach(function(i){typeof i.eventProperties=="function"&&se(o,i.eventProperties.call(t[i.pluginName],e))}),o},modifyOption:function(e,t,o){var i;return Me.forEach(function(n){e[n.pluginName]&&n.optionListeners&&typeof n.optionListeners[t]=="function"&&(i=n.optionListeners[t].call(e[n.pluginName],o))}),i}};function vn(r){var e=r.sortable,t=r.rootEl,o=r.name,i=r.targetEl,n=r.cloneEl,a=r.toEl,s=r.fromEl,l=r.oldIndex,f=r.newIndex,c=r.oldDraggableIndex,m=r.newDraggableIndex,d=r.originalEvent,p=r.putSortable,b=r.extraEventProperties;if(e=e||t&&t[F],!!e){var I,Y=e.options,re="on"+o.charAt(0).toUpperCase()+o.substr(1);window.CustomEvent&&!ae&&!ft?I=new CustomEvent(o,{bubbles:!0,cancelable:!0}):(I=document.createEvent("Event"),I.initEvent(o,!0,!0)),I.to=a||t,I.from=s||t,I.item=i||t,I.clone=n,I.oldIndex=l,I.newIndex=f,I.oldDraggableIndex=c,I.newDraggableIndex=m,I.originalEvent=d,I.pullMode=p?p.lastPutMode:void 0;var M=oe(oe({},b),ut.getEventProperties(o,e));for(var j in M)I[j]=M[j];t&&t.dispatchEvent(I),Y[re]&&Y[re].call(e,I)}}var bn=["evt"],A=function(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=o.evt,n=un(o,bn);ut.pluginEvent.bind(S)(e,t,oe({dragEl:h,parentEl:k,ghostEl:v,rootEl:x,nextEl:ke,lastDownEl:Pt,cloneEl:y,cloneHidden:he,dragStarted:tt,putSortable:R,activeSortable:S.active,originalEvent:i,oldIndex:Fe,oldDraggableIndex:st,newIndex:U,newDraggableIndex:me,hideGhostForTarget:qr,unhideGhostForTarget:Xr,cloneNowHidden:function(){he=!0},cloneNowShown:function(){he=!1},dispatchSortableEvent:function(s){_({sortable:t,name:s,originalEvent:i})}},n))};function _(r){vn(oe({putSortable:R,cloneEl:y,targetEl:h,rootEl:x,oldIndex:Fe,oldDraggableIndex:st,newIndex:U,newDraggableIndex:me},r))}var h,k,v,x,ke,Pt,y,he,Fe,U,st,me,kt,R,Ae=!1,Ft=!1,Ht=[],xe,Q,yo,ko,Rr,Lr,tt,_e,at,lt=!1,Dt=!1,Nt,P,Do=[],No=!1,Gt=[],Vt=typeof document!="undefined",Ot=Fo,Pr=ft||ae?"cssFloat":"float",Tn=Vt&&!Mr&&!Fo&&"draggable"in document.createElement("div"),Ur=function(){if(Vt){if(ae)return!1;var r=document.createElement("x");return r.style.cssText="pointer-events:auto",r.style.pointerEvents==="auto"}}(),Wr=function(e,t){var o=g(e),i=parseInt(o.width)-parseInt(o.paddingLeft)-parseInt(o.paddingRight)-parseInt(o.borderLeftWidth)-parseInt(o.borderRightWidth),n=Ge(e,0,t),a=Ge(e,1,t),s=n&&g(n),l=a&&g(a),f=s&&parseInt(s.marginLeft)+parseInt(s.marginRight)+O(n).width,c=l&&parseInt(l.marginLeft)+parseInt(l.marginRight)+O(a).width;if(o.display==="flex")return o.flexDirection==="column"||o.flexDirection==="column-reverse"?"vertical":"horizontal";if(o.display==="grid")return o.gridTemplateColumns.split(" ").length<=1?"vertical":"horizontal";if(n&&s.float&&s.float!=="none"){var m=s.float==="left"?"left":"right";return a&&(l.clear==="both"||l.clear===m)?"vertical":"horizontal"}return n&&(s.display==="block"||s.display==="flex"||s.display==="table"||s.display==="grid"||f>=i&&o[Pr]==="none"||a&&o[Pr]==="none"&&f+c>i)?"vertical":"horizontal"},Cn=function(e,t,o){var i=o?e.left:e.top,n=o?e.right:e.bottom,a=o?e.width:e.height,s=o?t.left:t.top,l=o?t.right:t.bottom,f=o?t.width:t.height;return i===s||n===l||i+a/2===s+f/2},En=function(e,t){var o;return Ht.some(function(i){var n=i[F].options.emptyInsertThreshold;if(!(!n||Ho(i))){var a=O(i),s=e>=a.left-n&&e<=a.right+n,l=t>=a.top-n&&t<=a.bottom+n;if(s&&l)return o=i}}),o},Kr=function(e){function t(n,a){return function(s,l,f,c){var m=s.options.group.name&&l.options.group.name&&s.options.group.name===l.options.group.name;if(n==null&&(a||m))return!0;if(n==null||n===!1)return!1;if(a&&n==="clone")return n;if(typeof n=="function")return t(n(s,l,f,c),a)(s,l,f,c);var d=(a?s:l).options.group.name;return n===!0||typeof n=="string"&&n===d||n.join&&n.indexOf(d)>-1}}var o={},i=e.group;(!i||Lt(i)!="object")&&(i={name:i}),o.name=i.name,o.checkPull=t(i.pull,!0),o.checkPut=t(i.put),o.revertClone=i.revertClone,e.group=o},qr=function(){!Ur&&v&&g(v,"display","none")},Xr=function(){!Ur&&v&&g(v,"display","")};Vt&&!Mr&&document.addEventListener("click",function(r){if(Ft)return r.preventDefault(),r.stopPropagation&&r.stopPropagation(),r.stopImmediatePropagation&&r.stopImmediatePropagation(),Ft=!1,!1},!0);var ye=function(e){if(h){e=e.touches?e.touches[0]:e;var t=En(e.clientX,e.clientY);if(t){var o={};for(var i in e)e.hasOwnProperty(i)&&(o[i]=e[i]);o.target=o.rootEl=t,o.preventDefault=void 0,o.stopPropagation=void 0,t[F]._onDragOver(o)}}},In=function(e){h&&h.parentNode[F]._isOutsideThisEl(e.target)};function S(r,e){if(!(r&&r.nodeType&&r.nodeType===1))throw"Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(r));this.el=r,this.options=e=se({},e),r[F]=this;var t={group:null,sort:!0,disabled:!1,store:null,handle:null,draggable:/^[uo]l$/i.test(r.nodeName)?">li":">*",swapThreshold:1,invertSwap:!1,invertedSwapThreshold:null,removeCloneOnHide:!0,direction:function(){return Wr(r,this.options)},ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",ignore:"a, img",filter:null,preventOnFilter:!0,animation:0,easing:null,setData:function(a,s){a.setData("Text",s.textContent)},dropBubble:!1,dragoverBubble:!1,dataIdAttr:"data-id",delay:0,delayOnTouchOnly:!1,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:!1,fallbackClass:"sortable-fallback",fallbackOnBody:!1,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:S.supportPointer!==!1&&"PointerEvent"in window&&(!it||Fo),emptyInsertThreshold:5};ut.initializePlugins(this,r,t);for(var o in t)!(o in e)&&(e[o]=t[o]);Kr(e);for(var i in this)i.charAt(0)==="_"&&typeof this[i]=="function"&&(this[i]=this[i].bind(this));this.nativeDraggable=e.forceFallback?!1:Tn,this.nativeDraggable&&(this.options.touchStartThreshold=1),e.supportPointer?E(r,"pointerdown",this._onTapStart):(E(r,"mousedown",this._onTapStart),E(r,"touchstart",this._onTapStart)),this.nativeDraggable&&(E(r,"dragover",this),E(r,"dragenter",this)),Ht.push(this.el),e.store&&e.store.get&&this.sort(e.store.get(this)||[]),se(this,pn())}S.prototype={constructor:S,_isOutsideThisEl:function(e){!this.el.contains(e)&&e!==this.el&&(_e=null)},_getDirection:function(e,t){return typeof this.options.direction=="function"?this.options.direction.call(this,e,t,h):this.options.direction},_onTapStart:function(e){if(e.cancelable){var t=this,o=this.el,i=this.options,n=i.preventOnFilter,a=e.type,s=e.touches&&e.touches[0]||e.pointerType&&e.pointerType==="touch"&&e,l=(s||e).target,f=e.target.shadowRoot&&(e.path&&e.path[0]||e.composedPath&&e.composedPath()[0])||l,c=i.filter;if(Ln(o),!h&&!(/mousedown|pointerdown/.test(a)&&e.button!==0||i.disabled)&&!f.isContentEditable&&!(!this.nativeDraggable&&it&&l&&l.tagName.toUpperCase()==="SELECT")&&(l=Z(l,i.draggable,o,!1),!(l&&l.animated)&&Pt!==l)){if(Fe=W(l),st=W(l,i.draggable),typeof c=="function"){if(c.call(this,e,l,this)){_({sortable:t,rootEl:f,name:"filter",targetEl:l,toEl:o,fromEl:o}),A("filter",t,{evt:e}),n&&e.preventDefault();return}}else if(c&&(c=c.split(",").some(function(m){if(m=Z(f,m.trim(),o,!1),m)return _({sortable:t,rootEl:m,name:"filter",targetEl:l,fromEl:o,toEl:o}),A("filter",t,{evt:e}),!0}),c)){n&&e.preventDefault();return}i.handle&&!Z(f,i.handle,o,!1)||this._prepareDragStart(e,s,l)}}},_prepareDragStart:function(e,t,o){var i=this,n=i.el,a=i.options,s=n.ownerDocument,l;if(o&&!h&&o.parentNode===n){var f=O(o);if(x=n,h=o,k=h.parentNode,ke=h.nextSibling,Pt=o,kt=a.group,S.dragged=h,xe={target:h,clientX:(t||e).clientX,clientY:(t||e).clientY},Rr=xe.clientX-f.left,Lr=xe.clientY-f.top,this._lastX=(t||e).clientX,this._lastY=(t||e).clientY,h.style["will-change"]="all",l=function(){if(A("delayEnded",i,{evt:e}),S.eventCanceled){i._onDrop();return}i._disableDelayedDragEvents(),!yr&&i.nativeDraggable&&(h.draggable=!0),i._triggerDragStart(e,t),_({sortable:i,name:"choose",originalEvent:e}),V(h,a.chosenClass,!0)},a.ignore.split(",").forEach(function(c){Fr(h,c.trim(),Oo)}),E(s,"dragover",ye),E(s,"mousemove",ye),E(s,"touchmove",ye),a.supportPointer?(E(s,"pointerup",i._onDrop),!this.nativeDraggable&&E(s,"pointercancel",i._onDrop)):(E(s,"mouseup",i._onDrop),E(s,"touchend",i._onDrop),E(s,"touchcancel",i._onDrop)),yr&&this.nativeDraggable&&(this.options.touchStartThreshold=4,h.draggable=!0),A("delayStart",this,{evt:e}),a.delay&&(!a.delayOnTouchOnly||t)&&(!this.nativeDraggable||!(ft||ae))){if(S.eventCanceled){this._onDrop();return}a.supportPointer?(E(s,"pointerup",i._disableDelayedDrag),E(s,"pointercancel",i._disableDelayedDrag)):(E(s,"mouseup",i._disableDelayedDrag),E(s,"touchend",i._disableDelayedDrag),E(s,"touchcancel",i._disableDelayedDrag)),E(s,"mousemove",i._delayedDragTouchMoveHandler),E(s,"touchmove",i._delayedDragTouchMoveHandler),a.supportPointer&&E(s,"pointermove",i._delayedDragTouchMoveHandler),i._dragStartTimer=setTimeout(l,a.delay)}else l()}},_delayedDragTouchMoveHandler:function(e){var t=e.touches?e.touches[0]:e;Math.max(Math.abs(t.clientX-this._lastX),Math.abs(t.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))&&this._disableDelayedDrag()},_disableDelayedDrag:function(){h&&Oo(h),clearTimeout(this._dragStartTimer),this._disableDelayedDragEvents()},_disableDelayedDragEvents:function(){var e=this.el.ownerDocument;C(e,"mouseup",this._disableDelayedDrag),C(e,"touchend",this._disableDelayedDrag),C(e,"touchcancel",this._disableDelayedDrag),C(e,"pointerup",this._disableDelayedDrag),C(e,"pointercancel",this._disableDelayedDrag),C(e,"mousemove",this._delayedDragTouchMoveHandler),C(e,"touchmove",this._delayedDragTouchMoveHandler),C(e,"pointermove",this._delayedDragTouchMoveHandler)},_triggerDragStart:function(e,t){t=t||e.pointerType=="touch"&&e,!this.nativeDraggable||t?this.options.supportPointer?E(document,"pointermove",this._onTouchMove):t?E(document,"touchmove",this._onTouchMove):E(document,"mousemove",this._onTouchMove):(E(h,"dragend",this),E(x,"dragstart",this._onDragStart));try{document.selection?Mt(function(){document.selection.empty()}):window.getSelection().removeAllRanges()}catch(o){}},_dragStarted:function(e,t){if(Ae=!1,x&&h){A("dragStarted",this,{evt:t}),this.nativeDraggable&&E(document,"dragover",In);var o=this.options;!e&&V(h,o.dragClass,!1),V(h,o.ghostClass,!0),S.active=this,e&&this._appendGhost(),_({sortable:this,name:"start",originalEvent:t})}else this._nulling()},_emulateDragOver:function(){if(Q){this._lastX=Q.clientX,this._lastY=Q.clientY,qr();for(var e=document.elementFromPoint(Q.clientX,Q.clientY),t=e;e&&e.shadowRoot&&(e=e.shadowRoot.elementFromPoint(Q.clientX,Q.clientY),e!==t);)t=e;if(h.parentNode[F]._isOutsideThisEl(e),t)do{if(t[F]){var o=void 0;if(o=t[F]._onDragOver({clientX:Q.clientX,clientY:Q.clientY,target:e,rootEl:t}),o&&!this.options.dragoverBubble)break}e=t}while(t=Ar(t));Xr()}},_onTouchMove:function(e){if(xe){var t=this.options,o=t.fallbackTolerance,i=t.fallbackOffset,n=e.touches?e.touches[0]:e,a=v&&He(v,!0),s=v&&a&&a.a,l=v&&a&&a.d,f=Ot&&P&&Or(P),c=(n.clientX-xe.clientX+i.x)/(s||1)+(f?f[0]-Do[0]:0)/(s||1),m=(n.clientY-xe.clientY+i.y)/(l||1)+(f?f[1]-Do[1]:0)/(l||1);if(!S.active&&!Ae){if(o&&Math.max(Math.abs(n.clientX-this._lastX),Math.abs(n.clientY-this._lastY))<o)return;this._onDragStart(e,!0)}if(v){a?(a.e+=c-(yo||0),a.f+=m-(ko||0)):a={a:1,b:0,c:0,d:1,e:c,f:m};var d="matrix(".concat(a.a,",").concat(a.b,",").concat(a.c,",").concat(a.d,",").concat(a.e,",").concat(a.f,")");g(v,"webkitTransform",d),g(v,"mozTransform",d),g(v,"msTransform",d),g(v,"transform",d),yo=c,ko=m,Q=n}e.cancelable&&e.preventDefault()}},_appendGhost:function(){if(!v){var e=this.options.fallbackOnBody?document.body:x,t=O(h,!0,Ot,!0,e),o=this.options;if(Ot){for(P=e;g(P,"position")==="static"&&g(P,"transform")==="none"&&P!==document;)P=P.parentNode;P!==document.body&&P!==document.documentElement?(P===document&&(P=te()),t.top+=P.scrollTop,t.left+=P.scrollLeft):P=te(),Do=Or(P)}v=h.cloneNode(!0),V(v,o.ghostClass,!1),V(v,o.fallbackClass,!0),V(v,o.dragClass,!0),g(v,"transition",""),g(v,"transform",""),g(v,"box-sizing","border-box"),g(v,"margin",0),g(v,"top",t.top),g(v,"left",t.left),g(v,"width",t.width),g(v,"height",t.height),g(v,"opacity","0.8"),g(v,"position",Ot?"absolute":"fixed"),g(v,"zIndex","100000"),g(v,"pointerEvents","none"),S.ghost=v,e.appendChild(v),g(v,"transform-origin",Rr/parseInt(v.style.width)*100+"% "+Lr/parseInt(v.style.height)*100+"%")}},_onDragStart:function(e,t){var o=this,i=e.dataTransfer,n=o.options;if(A("dragStart",this,{evt:e}),S.eventCanceled){this._onDrop();return}A("setupClone",this),S.eventCanceled||(y=Br(h),y.removeAttribute("id"),y.draggable=!1,y.style["will-change"]="",this._hideClone(),V(y,this.options.chosenClass,!1),S.clone=y),o.cloneId=Mt(function(){A("clone",o),!S.eventCanceled&&(o.options.removeCloneOnHide||x.insertBefore(y,h),o._hideClone(),_({sortable:o,name:"clone"}))}),!t&&V(h,n.dragClass,!0),t?(Ft=!0,o._loopId=setInterval(o._emulateDragOver,50)):(C(document,"mouseup",o._onDrop),C(document,"touchend",o._onDrop),C(document,"touchcancel",o._onDrop),i&&(i.effectAllowed="move",n.setData&&n.setData.call(o,i,h)),E(document,"drop",o),g(h,"transform","translateZ(0)")),Ae=!0,o._dragStartId=Mt(o._dragStarted.bind(o,t,e)),E(document,"selectstart",o),tt=!0,window.getSelection().removeAllRanges(),it&&g(document.body,"user-select","none")},_onDragOver:function(e){var t=this.el,o=e.target,i,n,a,s=this.options,l=s.group,f=S.active,c=kt===l,m=s.sort,d=R||f,p,b=this,I=!1;if(No)return;function Y(Je,Zi){A(Je,b,oe({evt:e,isOwner:c,axis:p?"vertical":"horizontal",revert:a,dragRect:i,targetRect:n,canSort:m,fromSortable:d,target:o,completed:M,onMove:function(pr,Ji){return Rt(x,t,h,i,pr,O(pr),e,Ji)},changed:j},Zi))}function re(){Y("dragOverAnimationCapture"),b.captureAnimationState(),b!==d&&d.captureAnimationState()}function M(Je){return Y("dragOverCompleted",{insertion:Je}),Je&&(c?f._hideClone():f._showClone(b),b!==d&&(V(h,R?R.options.ghostClass:f.options.ghostClass,!1),V(h,s.ghostClass,!0)),R!==b&&b!==S.active?R=b:b===S.active&&R&&(R=null),d===b&&(b._ignoreWhileAnimating=o),b.animateAll(function(){Y("dragOverAnimationComplete"),b._ignoreWhileAnimating=null}),b!==d&&(d.animateAll(),d._ignoreWhileAnimating=null)),(o===h&&!h.animated||o===t&&!o.animated)&&(_e=null),!s.dragoverBubble&&!e.rootEl&&o!==document&&(h.parentNode[F]._isOutsideThisEl(e.target),!Je&&ye(e)),!s.dragoverBubble&&e.stopPropagation&&e.stopPropagation(),I=!0}function j(){U=W(h),me=W(h,s.draggable),_({sortable:b,name:"change",toEl:t,newIndex:U,newDraggableIndex:me,originalEvent:e})}if(e.preventDefault!==void 0&&e.cancelable&&e.preventDefault(),o=Z(o,s.draggable,t,!0),Y("dragOver"),S.eventCanceled)return I;if(h.contains(e.target)||o.animated&&o.animatingX&&o.animatingY||b._ignoreWhileAnimating===o)return M(!1);if(Ft=!1,f&&!s.disabled&&(c?m||(a=k!==x):R===this||(this.lastPutMode=kt.checkPull(this,f,h,e))&&l.checkPut(this,f,h,e))){if(p=this._getDirection(e,o)==="vertical",i=O(h),Y("dragOverValid"),S.eventCanceled)return I;if(a)return k=x,re(),this._hideClone(),Y("revert"),S.eventCanceled||(ke?x.insertBefore(h,ke):x.appendChild(h)),M(!0);var H=Ho(t,s.draggable);if(!H||kn(e,p,this)&&!H.animated){if(H===h)return M(!1);if(H&&t===e.target&&(o=H),o&&(n=O(o)),Rt(x,t,h,i,o,n,e,!!o)!==!1)return re(),H&&H.nextSibling?t.insertBefore(h,H.nextSibling):t.appendChild(h),k=t,j(),M(!0)}else if(H&&yn(e,p,this)){var Te=Ge(t,0,s,!0);if(Te===h)return M(!1);if(o=Te,n=O(o),Rt(x,t,h,i,o,n,e,!1)!==!1)return re(),t.insertBefore(h,Te),k=t,j(),M(!0)}else if(o.parentNode===t){n=O(o);var ee=0,Ce,ze=h.parentNode!==t,G=!Cn(h.animated&&h.toRect||i,o.animated&&o.toRect||n,p),$e=p?"top":"left",ue=Dr(o,"top","top")||Dr(h,"top","top"),Qe=ue?ue.scrollTop:void 0;_e!==o&&(Ce=n[$e],lt=!1,Dt=!G&&s.invertSwap||ze),ee=Dn(e,o,n,p,G?1:s.swapThreshold,s.invertedSwapThreshold==null?s.swapThreshold:s.invertedSwapThreshold,Dt,_e===o);var ie;if(ee!==0){var Ee=W(h);do Ee-=ee,ie=k.children[Ee];while(ie&&(g(ie,"display")==="none"||ie===v))}if(ee===0||ie===o)return M(!1);_e=o,at=ee;var Ze=o.nextElementSibling,ce=!1;ce=ee===1;var Tt=Rt(x,t,h,i,o,n,e,ce);if(Tt!==!1)return(Tt===1||Tt===-1)&&(ce=Tt===1),No=!0,setTimeout(xn,30),re(),ce&&!Ze?t.appendChild(h):o.parentNode.insertBefore(h,ce?Ze:o),ue&&Gr(ue,0,Qe-ue.scrollTop),k=h.parentNode,Ce!==void 0&&!Dt&&(Nt=Math.abs(Ce-O(o)[$e])),j(),M(!0)}if(t.contains(h))return M(!1)}return!1},_ignoreWhileAnimating:null,_offMoveEvents:function(){C(document,"mousemove",this._onTouchMove),C(document,"touchmove",this._onTouchMove),C(document,"pointermove",this._onTouchMove),C(document,"dragover",ye),C(document,"mousemove",ye),C(document,"touchmove",ye)},_offUpEvents:function(){var e=this.el.ownerDocument;C(e,"mouseup",this._onDrop),C(e,"touchend",this._onDrop),C(e,"pointerup",this._onDrop),C(e,"pointercancel",this._onDrop),C(e,"touchcancel",this._onDrop),C(document,"selectstart",this)},_onDrop:function(e){var t=this.el,o=this.options;if(U=W(h),me=W(h,o.draggable),A("drop",this,{evt:e}),k=h&&h.parentNode,U=W(h),me=W(h,o.draggable),S.eventCanceled){this._nulling();return}Ae=!1,Dt=!1,lt=!1,clearInterval(this._loopId),clearTimeout(this._dragStartTimer),Mo(this.cloneId),Mo(this._dragStartId),this.nativeDraggable&&(C(document,"drop",this),C(t,"dragstart",this._onDragStart)),this._offMoveEvents(),this._offUpEvents(),it&&g(document.body,"user-select",""),g(h,"transform",""),e&&(tt&&(e.cancelable&&e.preventDefault(),!o.dropBubble&&e.stopPropagation()),v&&v.parentNode&&v.parentNode.removeChild(v),(x===k||R&&R.lastPutMode!=="clone")&&y&&y.parentNode&&y.parentNode.removeChild(y),h&&(this.nativeDraggable&&C(h,"dragend",this),Oo(h),h.style["will-change"]="",tt&&!Ae&&V(h,R?R.options.ghostClass:this.options.ghostClass,!1),V(h,this.options.chosenClass,!1),_({sortable:this,name:"unchoose",toEl:k,newIndex:null,newDraggableIndex:null,originalEvent:e}),x!==k?(U>=0&&(_({rootEl:k,name:"add",toEl:k,fromEl:x,originalEvent:e}),_({sortable:this,name:"remove",toEl:k,originalEvent:e}),_({rootEl:k,name:"sort",toEl:k,fromEl:x,originalEvent:e}),_({sortable:this,name:"sort",toEl:k,originalEvent:e})),R&&R.save()):U!==Fe&&U>=0&&(_({sortable:this,name:"update",toEl:k,originalEvent:e}),_({sortable:this,name:"sort",toEl:k,originalEvent:e})),S.active&&((U==null||U===-1)&&(U=Fe,me=st),_({sortable:this,name:"end",toEl:k,originalEvent:e}),this.save()))),this._nulling()},_nulling:function(){A("nulling",this),x=h=k=v=ke=y=Pt=he=xe=Q=tt=U=me=Fe=st=_e=at=R=kt=S.dragged=S.ghost=S.clone=S.active=null,Gt.forEach(function(e){e.checked=!0}),Gt.length=yo=ko=0},handleEvent:function(e){switch(e.type){case"drop":case"dragend":this._onDrop(e);break;case"dragenter":case"dragover":h&&(this._onDragOver(e),wn(e));break;case"selectstart":e.preventDefault();break}},toArray:function(){for(var e=[],t,o=this.el.children,i=0,n=o.length,a=this.options;i<n;i++)t=o[i],Z(t,a.draggable,this.el,!1)&&e.push(t.getAttribute(a.dataIdAttr)||Rn(t));return e},sort:function(e,t){var o={},i=this.el;this.toArray().forEach(function(n,a){var s=i.children[a];Z(s,this.options.draggable,i,!1)&&(o[n]=s)},this),t&&this.captureAnimationState(),e.forEach(function(n){o[n]&&(i.removeChild(o[n]),i.appendChild(o[n]))}),t&&this.animateAll()},save:function(){var e=this.options.store;e&&e.set&&e.set(this)},closest:function(e,t){return Z(e,t||this.options.draggable,this.el,!1)},option:function(e,t){var o=this.options;if(t===void 0)return o[e];var i=ut.modifyOption(this,e,t);typeof i!="undefined"?o[e]=i:o[e]=t,e==="group"&&Kr(o)},destroy:function(){A("destroy",this);var e=this.el;e[F]=null,C(e,"mousedown",this._onTapStart),C(e,"touchstart",this._onTapStart),C(e,"pointerdown",this._onTapStart),this.nativeDraggable&&(C(e,"dragover",this),C(e,"dragenter",this)),Array.prototype.forEach.call(e.querySelectorAll("[draggable]"),function(t){t.removeAttribute("draggable")}),this._onDrop(),this._disableDelayedDragEvents(),Ht.splice(Ht.indexOf(this.el),1),this.el=e=null},_hideClone:function(){if(!he){if(A("hideClone",this),S.eventCanceled)return;g(y,"display","none"),this.options.removeCloneOnHide&&y.parentNode&&y.parentNode.removeChild(y),he=!0}},_showClone:function(e){if(e.lastPutMode!=="clone"){this._hideClone();return}if(he){if(A("showClone",this),S.eventCanceled)return;h.parentNode==x&&!this.options.group.revertClone?x.insertBefore(y,h):ke?x.insertBefore(y,ke):x.appendChild(y),this.options.group.revertClone&&this.animate(h,y),g(y,"display",""),he=!1}}};function wn(r){r.dataTransfer&&(r.dataTransfer.dropEffect="move"),r.cancelable&&r.preventDefault()}function Rt(r,e,t,o,i,n,a,s){var l,f=r[F],c=f.options.onMove,m;return window.CustomEvent&&!ae&&!ft?l=new CustomEvent("move",{bubbles:!0,cancelable:!0}):(l=document.createEvent("Event"),l.initEvent("move",!0,!0)),l.to=e,l.from=r,l.dragged=t,l.draggedRect=o,l.related=i||e,l.relatedRect=n||O(e),l.willInsertAfter=s,l.originalEvent=a,r.dispatchEvent(l),c&&(m=c.call(f,l,a)),m}function Oo(r){r.draggable=!1}function xn(){No=!1}function yn(r,e,t){var o=O(Ge(t.el,0,t.options,!0)),i=Vr(t.el,t.options,v),n=10;return e?r.clientX<i.left-n||r.clientY<o.top&&r.clientX<o.right:r.clientY<i.top-n||r.clientY<o.bottom&&r.clientX<o.left}function kn(r,e,t){var o=O(Ho(t.el,t.options.draggable)),i=Vr(t.el,t.options,v),n=10;return e?r.clientX>i.right+n||r.clientY>o.bottom&&r.clientX>o.left:r.clientY>i.bottom+n||r.clientX>o.right&&r.clientY>o.top}function Dn(r,e,t,o,i,n,a,s){var l=o?r.clientY:r.clientX,f=o?t.height:t.width,c=o?t.top:t.left,m=o?t.bottom:t.right,d=!1;if(!a){if(s&&Nt<f*i){if(!lt&&(at===1?l>c+f*n/2:l<m-f*n/2)&&(lt=!0),lt)d=!0;else if(at===1?l<c+Nt:l>m-Nt)return-at}else if(l>c+f*(1-i)/2&&l<m-f*(1-i)/2)return On(e)}return d=d||a,d&&(l<c+f*n/2||l>m-f*n/2)?l>c+f/2?1:-1:0}function On(r){return W(h)<W(r)?1:-1}function Rn(r){for(var e=r.tagName+r.className+r.src+r.href+r.textContent,t=e.length,o=0;t--;)o+=e.charCodeAt(t);return o.toString(36)}function Ln(r){Gt.length=0;for(var e=r.getElementsByTagName("input"),t=e.length;t--;){var o=e[t];o.checked&&Gt.push(o)}}function Mt(r){return setTimeout(r,0)}function Mo(r){return clearTimeout(r)}Vt&&E(document,"touchmove",function(r){(S.active||Ae)&&r.cancelable&&r.preventDefault()});S.utils={on:E,off:C,css:g,find:Fr,is:function(e,t){return!!Z(e,t,e,!1)},extend:hn,throttle:Hr,closest:Z,toggleClass:V,clone:Br,index:W,nextTick:Mt,cancelNextTick:Mo,detectDirection:Wr,getChild:Ge,expando:F};S.get=function(r){return r[F]};S.mount=function(){for(var r=arguments.length,e=new Array(r),t=0;t<r;t++)e[t]=arguments[t];e[0].constructor===Array&&(e=e[0]),e.forEach(function(o){if(!o.prototype||!o.prototype.constructor)throw"Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(o));o.utils&&(S.utils=oe(oe({},S.utils),o.utils)),ut.mount(o)})};S.create=function(r,e){return new S(r,e)};S.version=cn;var D=[],ot,_o,Ao=!1,Ro,Lo,Bt,rt;function Pn(){function r(){this.defaults={scroll:!0,forceAutoScrollFallback:!1,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:!0};for(var e in this)e.charAt(0)==="_"&&typeof this[e]=="function"&&(this[e]=this[e].bind(this))}return r.prototype={dragStarted:function(t){var o=t.originalEvent;this.sortable.nativeDraggable?E(document,"dragover",this._handleAutoScroll):this.options.supportPointer?E(document,"pointermove",this._handleFallbackAutoScroll):o.touches?E(document,"touchmove",this._handleFallbackAutoScroll):E(document,"mousemove",this._handleFallbackAutoScroll)},dragOverCompleted:function(t){var o=t.originalEvent;!this.options.dragOverBubble&&!o.rootEl&&this._handleAutoScroll(o)},drop:function(){this.sortable.nativeDraggable?C(document,"dragover",this._handleAutoScroll):(C(document,"pointermove",this._handleFallbackAutoScroll),C(document,"touchmove",this._handleFallbackAutoScroll),C(document,"mousemove",this._handleFallbackAutoScroll)),Nr(),_t(),dn()},nulling:function(){Bt=_o=ot=Ao=rt=Ro=Lo=null,D.length=0},_handleFallbackAutoScroll:function(t){this._handleAutoScroll(t,!0)},_handleAutoScroll:function(t,o){var i=this,n=(t.touches?t.touches[0]:t).clientX,a=(t.touches?t.touches[0]:t).clientY,s=document.elementFromPoint(n,a);if(Bt=t,o||this.options.forceAutoScrollFallback||ft||ae||it){Po(t,this.options,s,o);var l=de(s,!0);Ao&&(!rt||n!==Ro||a!==Lo)&&(rt&&Nr(),rt=setInterval(function(){var f=de(document.elementFromPoint(n,a),!0);f!==l&&(l=f,_t()),Po(t,i.options,f,o)},10),Ro=n,Lo=a)}else{if(!this.options.bubbleScroll||de(s,!0)===te()){_t();return}Po(t,this.options,de(s,!1),!1)}}},se(r,{pluginName:"scroll",initializeByDefault:!0})}function _t(){D.forEach(function(r){clearInterval(r.pid)}),D=[]}function Nr(){clearInterval(rt)}var Po=Hr(function(r,e,t,o){if(e.scroll){var i=(r.touches?r.touches[0]:r).clientX,n=(r.touches?r.touches[0]:r).clientY,a=e.scrollSensitivity,s=e.scrollSpeed,l=te(),f=!1,c;_o!==t&&(_o=t,_t(),ot=e.scroll,c=e.scrollFn,ot===!0&&(ot=de(t,!0)));var m=0,d=ot;do{var p=d,b=O(p),I=b.top,Y=b.bottom,re=b.left,M=b.right,j=b.width,H=b.height,Te=void 0,ee=void 0,Ce=p.scrollWidth,ze=p.scrollHeight,G=g(p),$e=p.scrollLeft,ue=p.scrollTop;p===l?(Te=j<Ce&&(G.overflowX==="auto"||G.overflowX==="scroll"||G.overflowX==="visible"),ee=H<ze&&(G.overflowY==="auto"||G.overflowY==="scroll"||G.overflowY==="visible")):(Te=j<Ce&&(G.overflowX==="auto"||G.overflowX==="scroll"),ee=H<ze&&(G.overflowY==="auto"||G.overflowY==="scroll"));var Qe=Te&&(Math.abs(M-i)<=a&&$e+j<Ce)-(Math.abs(re-i)<=a&&!!$e),ie=ee&&(Math.abs(Y-n)<=a&&ue+H<ze)-(Math.abs(I-n)<=a&&!!ue);if(!D[m])for(var Ee=0;Ee<=m;Ee++)D[Ee]||(D[Ee]={});(D[m].vx!=Qe||D[m].vy!=ie||D[m].el!==p)&&(D[m].el=p,D[m].vx=Qe,D[m].vy=ie,clearInterval(D[m].pid),(Qe!=0||ie!=0)&&(f=!0,D[m].pid=setInterval(function(){o&&this.layer===0&&S.active._onTouchMove(Bt);var Ze=D[this.layer].vy?D[this.layer].vy*s:0,ce=D[this.layer].vx?D[this.layer].vx*s:0;typeof c=="function"&&c.call(S.dragged.parentNode[F],ce,Ze,r,Bt,D[this.layer].el)!=="continue"||Gr(D[this.layer].el,ce,Ze)}.bind({layer:m}),24))),m++}while(e.bubbleScroll&&d!==l&&(d=de(d,!1)));Ao=f}},30),Yr=function(e){var t=e.originalEvent,o=e.putSortable,i=e.dragEl,n=e.activeSortable,a=e.dispatchSortableEvent,s=e.hideGhostForTarget,l=e.unhideGhostForTarget;if(t){var f=o||n;s();var c=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:t,m=document.elementFromPoint(c.clientX,c.clientY);l(),f&&!f.el.contains(m)&&(a("spill"),this.onSpill({dragEl:i,putSortable:o}))}};function Go(){}Go.prototype={startIndex:null,dragStart:function(e){var t=e.oldDraggableIndex;this.startIndex=t},onSpill:function(e){var t=e.dragEl,o=e.putSortable;this.sortable.captureAnimationState(),o&&o.captureAnimationState();var i=Ge(this.sortable.el,this.startIndex,this.options);i?this.sortable.el.insertBefore(t,i):this.sortable.el.appendChild(t),this.sortable.animateAll(),o&&o.animateAll()},drop:Yr};se(Go,{pluginName:"revertOnSpill"});function Bo(){}Bo.prototype={onSpill:function(e){var t=e.dragEl,o=e.putSortable,i=o||this.sortable;i.captureAnimationState(),t.parentNode&&t.parentNode.removeChild(t),i.animateAll()},drop:Yr};se(Bo,{pluginName:"removeOnSpill"});S.mount(new Pn);S.mount(Bo,Go);var jr=S;var De=require("obsidian");var pe={0:"Disable all",2:"Editor only",1:"Preview only",3:"Enable all"};var Vo={0:"Always visible",1:"When touching the tag itself",2:"When touching its syntax"};var zr={0:"Default",2:"Editor only",1:"Preview only",3:"Both editor and preview"};var $r={type:5,addBtnPlaceholder:"Add color",nameFieldPlaceholder:"Color name",tagFieldPlaceholder:"Tag string",tagFilter:/[^a-z0-9-]/gi,onAdd:(r,e,t)=>{e.addColorPicker(o=>{let i=r.plugin,n=i.settings.colorConfigs;o.setValue(t.color),o.colorPickerEl.addClasses(["ems-field","ems-field-color-picker"]),o.onChange(a=>{t.color=a;let s=n.findIndex(f=>f==t),l=Ne(t);i.colorsHandler.replace(l,s),r.saveSettings({colors:!0})})})},onMove:(r,e,t)=>{r.plugin.colorsHandler.moveRule(e,t)},onResetted:r=>{r.saveSettings({colors:!0})},onDelete:(r,e)=>{r.plugin.colorsHandler.removeSingle(e)},onTagChange:(r,e,t)=>{let o=Ne(e);r.plugin.colorsHandler.replace(o,t)}};var Qr={type:6,addBtnPlaceholder:"Add tag",nameFieldPlaceholder:"Tag name",tagFieldPlaceholder:"Tag string",tagFilter:/[^ a-z0-9-]/gi};var Zr={type:7,addBtnPlaceholder:"Add tag",nameFieldPlaceholder:"Tag name",tagFieldPlaceholder:"Tag string",tagFilter:/[^ a-z0-9-]/gi};function ct(r,e){switch(e){case 5:return r.colorConfigs;case 6:return r.predefinedSpanTag;case 7:return r.predefinedDivTag}}function Jr(r){return[{id:"syntax-switch",heading:"Syntax switch",collapsible:!0,items:[{name:"Insertion (underline)",desc:'Use double plus ("++") as a delimiter.',fields:[{type:2,record:r,key:"insertion",spec:{options:pe},update:{internal:!0}}]},{name:"Discord-flavored spoiler",desc:'Use double bars ("||") as a delimiter.',fields:[{type:2,record:r,key:"spoiler",spec:{options:pe},update:{internal:!0}}]},{name:"Pandoc-style superscript",desc:'Use a single caret ("^") as a delimiter.',fields:[{type:2,record:r,key:"superscript",spec:{options:pe},update:{internal:!0}}]},{name:"Pandoc-style subscript",desc:'Use a single tilde ("~") as a delimiter.',fields:[{type:2,record:r,key:"subscript",spec:{options:pe},update:{internal:!0}}]},{name:"Highlight color tag",desc:'Use alphanumeric and hyphen characters ("A-Za-z0-9-") after the opening delimiter covered by curly brackets ("{}").',fields:[{type:2,record:r,key:"customHighlight",spec:{options:pe},update:{internal:!0}}]},{name:"Custom span",desc:'Use double exclamation marks ("!!") as a delimiter. Can be inserted after the opening delimiter by a tag with the same way as highlight tag. Additionally, you can use multiple classes inside it, separated by space(s).',fields:[{type:2,record:r,key:"customSpan",spec:{options:pe},update:{internal:!0}}]},{name:"Pandoc-style fenced div (custom block)",desc:'Use three colons (":::") or more at the beginning of a paragraph, followed by alphanumeric and hyphen character ("A-Za-z0-9") after them. Use space to separate each class.',fields:[{type:2,record:r,key:"fencedDiv",spec:{options:pe},update:{internal:!0}}]}]},{id:"formatting",heading:"Formatting",collapsible:!0,items:[{name:"Make it tidier",desc:"If turned on, formatting will run in refined way by detecting context the cursor or selection was placed within, e.g. you just place a cursor to specific word and run the command to format the whole word or vice-versa. If turned off, formatting is more like a normal auto-wrap toggle and doesn't care about the context.",fields:[{type:0,record:r,key:"tidyFormatting",spec:null}]},{name:"Open tag menu after formatting",desc:"Will automatically open tag menu after doing formatting via command palattes or context menu. Only applied to the custom highlight, custom span, and fenced div.",fields:[{type:0,record:r,key:"openTagMenuAfterFormat",spec:null}]}]},{id:"tag-display",heading:"Tag display behavior",collapsible:!0,items:[{name:"Highlight tag in live-preview mode",desc:"Tags can either always be visible, or when they meet particular condition.",fields:[{type:2,record:r,key:"hlTagDisplayBehaviour",spec:{options:Vo},update:{internal:!0}}]},{name:"Custom span tag in live-preview mode",desc:"Tags can either always be visible, or when they meet particular condition.",fields:[{type:2,record:r,key:"spanTagDisplayBehaviour",spec:{options:Vo},update:{internal:!0}}]},{name:"Highlight tag in preview mode",desc:"Show or hide highlight color tag in the preview mode.",fields:[{type:0,record:r,key:"showHlTagInPreviewMode",spec:null,update:{internal:!0}}]},{name:"Custom span tag in preview mode",desc:"Show or hide custom span tag in the preview mode.",fields:[{type:0,record:r,key:"showSpanTagInPreviewMode",spec:null,update:{internal:!0}}]},{name:"Always show fenced div tag",desc:"By default, the tag is always hidden in the preview mode, and only displayed when touching the cursor or selection in the live preview mode.",fields:[{type:2,record:r,key:"alwaysShowFencedDivTag",spec:{options:zr},update:{internal:!0}}]}]},{id:"custom-highlight",heading:"Custom highlight",collapsible:!0,items:[{name:"Color button",desc:"Display a button after highlight opening delimiter, used to open the color menu.",fields:[{type:0,record:r,key:"colorButton",spec:null,update:{internal:!0}}]},{name:"Show accent option",desc:"Show accent option in the color menu.",fields:[{type:0,record:r,key:"showAccentColor",spec:null}]},{name:"Show default option",desc:"Show default option in the color menu. Default means non-tagged highlight.",fields:[{type:0,record:r,key:"showDefaultColor",spec:null}]},{name:"Show remove option",desc:"Show remove option in the color menu.",fields:[{type:0,record:r,key:"showRemoveColor",spec:null}]},{name:"Color opacity in light mode",desc:"Adjust highlight opacity in light mode. Zero means that will be fully transparent.",fields:[{type:6,record:r,key:"lightModeHlOpacity",spec:{min:0,max:1,step:.01},callback:(e,t)=>{t.setHlOpacity(e.getValue(),0)},update:{colors:!0}}]},{name:"Color opacity in dark mode",desc:"Adjust highlight opacity in dark mode. Zero means that will be fully transparent.",fields:[{type:6,record:r,key:"darkModeHlOpacity",spec:{min:0,max:1,step:.01},callback:(e,t)=>{t.setHlOpacity(e.getValue(),1)},update:{colors:!0}}]},{name:"Color palettes",desc:"The first text field gives the name of the item in the color menu, and the second one sets the tag string to be used in highlight syntax.",preservedForTagSettings:5}]},{id:"custom-span",heading:"Custom span",collapsible:!0,items:[{name:"Show default option",desc:"Show default option in the tag menu. Default means non-tagged span.",fields:[{type:0,record:r,key:"showDefaultSpanTag",spec:null}]},{name:"Show remove option",desc:"Show remove option in the tag menu.",fields:[{type:0,record:r,key:"showRemoveSpanTag",spec:null}]},{name:"Predefined tags",desc:"Predefined tags to be displayed in the tag menu. The first field gives the name of the item, the second one sets the tag string to be used in custom span syntax.",preservedForTagSettings:6}]},{id:"fenced-div",heading:"Fenced div",collapsible:!0,items:[{name:"Show default option",desc:"Show default option in the tag menu. Default means non-tagged div.",fields:[{type:0,record:r,key:"showDefaultDivTag",spec:null}]},{name:"Show remove option",desc:"Show remove option in the tag menu.",fields:[{type:0,record:r,key:"showRemoveDivTag",spec:null}]},{name:"Predefined tags",desc:"Predefined tags to be displayed in the tag menu. The first field gives the name of the item, the second one sets the tag string to be used in fenced div syntax.",preservedForTagSettings:7}]},{id:"others",heading:"Others",collapsible:!0,items:[{name:"Delimiter escaping",desc:"Use backslash as a delimiter escaper. Works only in the editor mode.",fields:[{type:0,record:r,key:"editorEscape",spec:null,update:{internal:!0}}]},{name:"Parse exported PDF",desc:"Parse syntax on an exported PDF.",fields:[{type:0,record:r,key:"decoratePDF",spec:null}]}]}]}function Uo(r,e,t,o){return r.addButton(i=>{i.setButtonText(e),i.onClick(o),t&&i.setCta()}),r}function ei(r){for(let e=r.nextElementSibling;e!=null&&e.hasClass("is-collapsible");e=e.nextElementSibling)e.hasClass("collapsed")?e.removeClass("collapsed"):e.addClass("collapsed")}var Ut=class extends De.PluginSettingTab{constructor(t,o){super(t,o);u(this,"plugin");u(this,"tagSettingItems",{5:[],6:[],7:[]});u(this,"collapsedGroups",{"syntax-switch":!0,formatting:!0,"tag-display":!0,"custom-highlight":!0,"custom-span":!0,"fenced-div":!0,others:!0});u(this,"rebuildColorStyleRules",!1);u(this,"refreshInternal",!1);u(this,"isHidden",!0);this.plugin=o}saveSettings(t){this.plugin.saveSettings(),t!=null&&t.internal&&(this.refreshInternal=!0),t!=null&&t.colors&&(this.rebuildColorStyleRules=!0)}display(){let{containerEl:t}=this,{settings:o}=this.plugin;t.empty();let i=Jr(o);this.drawFromConfig(i,t),this.isHidden=!1}hide(){this.refreshInternal&&this.plugin.refreshMarkdownView(),this.rebuildColorStyleRules&&this.plugin.rebuildColorsStyleSheet(),this.refreshInternal=this.rebuildColorStyleRules=!1,this.emptyTagSettingItems(),this.isHidden=!0,super.hide()}emptyTagSettingItems(){for(let t of[5,6,7])this.tagSettingItems[t].splice(0)}removeSetting(t){t.clear(),t.settingEl.remove()}drawFromConfig(t,o){for(let i of t){let n=this.collapsedGroups[i.id];i.heading&&this.drawHeading(i,o);for(let a of i.items)this.drawSettingItem(a,o,i.collapsible,n),a.preservedForTagSettings==5?this.drawTagSettings(o,$r,i.collapsible,n):a.preservedForTagSettings==6?this.drawTagSettings(o,Qr,i.collapsible,n):a.preservedForTagSettings==7&&this.drawTagSettings(o,Zr,i.collapsible,n)}}drawHeading(t,o){if(!t.heading)return;let i=new De.Setting(o).setHeading().setName(t.heading);t.desc&&i.setDesc(t.desc),t.collapsible&&(i.addExtraButton(n=>{let a=n.extraSettingsEl;n.setIcon("chevron-down").onClick(()=>{let s=n.extraSettingsEl;ei(i.settingEl),s.hasClass("collapsing")?(n.setTooltip("Collapse",{placement:"bottom"}),s.removeClass("collapsing"),delete this.collapsedGroups[t.id]):(n.setTooltip("Expand",{placement:"bottom"}),s.addClass("collapsing"),this.collapsedGroups[t.id]=!0)}),a.addClass("collapse-button","ems-button"),this.collapsedGroups[t.id]?(a.addClass("collapsing"),n.setTooltip("Expand",{placement:"bottom"})):n.setTooltip("Collapse",{placement:"bottom"})}),i.controlEl.addClass("collapse-control"))}drawSettingItem(t,o,i,n){let a=new De.Setting(o).setName(t.name);if(t.desc&&a.setDesc(t.desc),i&&(a.setClass("is-collapsible"),n&&a.setClass("collapsed")),t.fields)for(let s of t.fields)s.type==0?this.setToggleField(s,a):s.type==2?this.setDropdownField(s,a):s.type==1?this.setMultiToggleField(s,a):s.type==6&&this.setSliderField(s,a)}drawTagSettings(t,o,i,n){let a=ct(this.plugin.settings,o.type),s=t.createDiv({cls:["setting-item","setting-group","ems-setting-group"]});a.forEach(f=>{this.setTagItem(o,f,a,s)});let l=new De.Setting(t);Uo(l,o.addBtnPlaceholder,!1,()=>{var c;this.plugin.addTagConfig(o.type),(c=this.setTagItem(o,a.at(-1),a,s).controlEl.querySelector(".ems-field-tag"))==null||c.focus(),this.saveSettings()}),Uo(l,"Reset to default",!0,()=>{var f;this.tagSettingItems[o.type].forEach(c=>{this.removeSetting(c)}),this.tagSettingItems[o.type].splice(0),this.plugin.revertTagConfigs(o.type,(c,m)=>{this.setTagItem(o,c,m,s)}),this.saveSettings(),(f=o.onResetted)==null||f.call(o,this)}),i&&(l.setClass("is-collapsible"),s.addClass("is-collapsible"),n&&(l.setClass("collapsed"),s.addClass("collapsed"))),this.makeDragable(s,f=>{var d;let c=f.oldDraggableIndex,m=f.newDraggableIndex;this.isHidden||c===void 0||m===void 0||c==m||(a.splice(Math.min(c,m),0,...a.splice(Math.max(c,m),1)),(d=o.onMove)==null||d.call(o,this,c,m))})}setTagItem(t,o,i,n){var s;o.tag=o.tag.replaceAll(t.tagFilter,"");let a=new De.Setting(n).setClass("ems-setting-item").setClass("ems-tag-config").addExtraButton(l=>{l.extraSettingsEl.addClasses(["ems-button","ems-button-drag-handle"]),l.setIcon("grip-vertical"),l.setTooltip("Hold and drag to move",{placement:"left"})}).addText(l=>{l.setPlaceholder(t.nameFieldPlaceholder),l.setValue(o.name),l.inputEl.addClasses(["ems-field","ems-field-name"]),l.onChange(f=>{o.name=f,this.saveSettings()})}).addExtraButton(l=>{l.extraSettingsEl.addClasses(["ems-button","ems-button-delete"]),l.setIcon("trash"),l.setTooltip("Delete"),l.onClick(()=>{var m;let c=i.findIndex(d=>d==o);i.splice(c,1),this.tagSettingItems[t.type].splice(c,1),this.removeSetting(a),this.saveSettings(),(m=t.onDelete)==null||m.call(t,this,c)})}).addExtraButton(l=>{l.extraSettingsEl.addClasses(["ems-button","ems-button-toggle-show-hide"]),l.setIcon(o.showInMenu?"eye":"eye-off"),l.setTooltip("Show/hide menu item"),l.onClick(()=>{o.showInMenu=!o.showInMenu,l.setIcon(o.showInMenu?"eye":"eye-off"),this.saveSettings()})}).addText(l=>{l.setPlaceholder(t.tagFieldPlaceholder),l.inputEl.addClasses(["ems-field","ems-field-tag"]),l.setValue(o.tag),l.onChange(f=>{var m;let c=i.findIndex(d=>d==o);o.tag=f.replaceAll(t.tagFilter,""),l.setValue(o.tag),this.saveSettings(),(m=t.onTagChange)==null||m.call(t,this,o,c)})});return(s=t.onAdd)==null||s.call(t,this,a,o),a}setToggleField(t,o){o.addToggle(i=>{let{record:n,key:a}=t;i.setValue(n[a]),i.onChange(s=>{n[a]=s,this.saveSettings(t.update),t.callback&&t.callback(i,this.plugin)})})}setDropdownField(t,o){o.addDropdown(i=>{let{record:n,key:a}=t;i.addOptions(t.spec.options),i.setValue(n[a].toString()),i.onChange(s=>{n[a]=parseInt(s),this.saveSettings(t.update),t.callback&&t.callback(i,this.plugin)})})}setMultiToggleField(t,o){let{record:i,key:n}=t,a=i[n],s=t.spec.options,l=(()=>{let c=[];for(let m in s)c.push(m);return c})(),f=l.findIndex(c=>c===a.toString());o.addExtraButton(c=>{let{icon:m,tooltip:d}=s[a];c.setIcon(m),c.setTooltip(d!=null?d:""),c.onClick(()=>{f+1>=l.length?f=0:f++;let p=parseInt(l[f]),{icon:b,tooltip:I}=s[p];c.setIcon(b),c.setTooltip(I!=null?I:""),i[n]=p,this.saveSettings(t.update),t.callback&&t.callback(c,this.plugin)})})}setSliderField(t,o){o.addSlider(i=>{let{record:n,key:a,spec:s}=t;i.setInstant(!1),i.setDynamicTooltip(),i.setLimits(s.min,s.max,s.step),i.setValue(n[a]),i.onChange(l=>{n[a]=l,this.saveSettings(t.update),t.callback&&t.callback(i,this.plugin)})})}makeDragable(t,o){jr.create(t,{handle:".ems-button-drag-handle",animation:100,easing:"cubic-bezier(0.2, 0, 0, 1)",forceFallback:!0,fallbackOnBody:!0,fallbackClass:"ems-setting-item-dragged",fallbackTolerance:4,onEnd:o})}};var ti=require("@codemirror/state"),Be=ti.Facet.define({combine(r){return r[0]},static:!0});var oi=require("@codemirror/state"),Wt=oi.Facet.define({combine(r){return r[0]},static:!0});var ri=require("@codemirror/state"),Kt=ri.Facet.define({combine(r){return r[0]},static:!0});var ni=require("@codemirror/state");function Wo(r,e){return r>=e.from&&r<=e.to}function qt(r,e){let t=[];for(let o=0,i=0;o<r.length||i<e.length;){if(!e[i]||r[o]&&r[o].to<e[i].from){t.push(Object.assign({},r[o])),o++;continue}if(!r[o]||e[i]&&e[i].to<r[o].from){t.push(Object.assign({},e[i])),i++;continue}t.push({from:Math.min(r[o].from,e[i].from),to:Math.max(r[o].to,e[i].to)}),o++,i++}return t}function Oe(r){return r>=5||r==7}function Ve(r){return r>=1&&r<=6}var mt={"table-row":{query:"table-row",getOpen(r){for(;!r.name.includes("table-row-0");)r=r.prevSibling;return r}},url:{query:"url",getOpen(r){return r}},math:{query:"math",getOpen(r){var e,t,o,i;for(;!r.name.includes("math-begin");){let n=(i=(o=r.prevSibling)!=null?o:(t=(e=r.parent)==null?void 0:e.prevSibling)==null?void 0:t.lastChild)!=null?i:null;if(!n)return null;r=n}return r.to-r.from!=1?null:r}},link:{query:"link(?<=internal-link)|link(?=-start|end)",getOpen(r){for(;!r.name.includes("link-start");)r=r.prevSibling;return r}},"formatting-list":{query:"formatting-list",getOpen(r){return r.parent}},hr:{query:"hr",getOpen(r){return r}},"codeblock-begin":{query:"codeblock-begin",getOpen(r){return r}},"formatting-header":{query:"formatting-header",getOpen(r){return r=r.parent,r.name.includes("header-line")&&(r=r.prevSibling),r}},"formatting-quote":{query:"formatting-quote",getOpen(r){return r.parent}},"hmd-footnote":{query:"hmd-footnote",getOpen(r){return r.parent}}};var K={};function Xt(r){r.insertion&2&&(K[T[1].char]=1),r.spoiler&2&&(K[T[2].char]=2),r.superscript&2&&(K[T[3].char]=3),r.subscript&2&&(K[T[4].char]=4),r.customHighlight&2&&(K[T[5].char]=5),r.customSpan&2&&(K[T[6].char]=6),r.insertion&1&&($[T[1].char]=1),r.spoiler&1&&($[T[2].char]=2),r.superscript&1&&($[T[3].char]=3),r.subscript&1&&($[T[4].char]=4),r.customSpan&1&&($[T[6].char]=6)}function ii(r){for(let e in K)delete K[e];for(let e in $)delete $[e];Xt(r)}var Yt=class{constructor(e){u(this,"selectedRegions",{1:[],0:[]});u(this,"maps",[]);u(this,"changedRegions",{1:[],0:[]});u(this,"filterRegions",{1:[],0:[]});u(this,"indexCaches",{1:{number:0},0:{number:0},selection:{number:0}});u(this,"handlers",{1:[],0:[]});u(this,"isObserving");u(this,"selection");u(this,"parser");this.parser=e}observe(e,t,o=!1){this.selection=e,this.checkIndexCache(),this.isObserving=!0;for(let i=0;i<=1;i++){let n=this.selectedRegions[i];this.locateSelectedTokens(i),i!=1&&(this.mapChangedRegion(i,n,t,o),this.createFilter(i))}}restartObserver(e,t){this.selectedRegions={0:[],1:[]},this.observe(e,t,!0)}locateSelectedTokens(e){var i,n;let t=[],o;return this.clearMaps(),this.lookBehind(e,(a,s,l)=>{var f;(f=this.maps[l])!=null&&f[e]?this.maps[l][e].unshift(s):this.maps[l]={[e]:[s]},!o||o.from!=s+1?(o={from:s,to:s+1},t.unshift(o)):o.from--}),o=t.at(-1),this.lookAhead(e,(a,s,l)=>{var f;(f=this.maps[l])!=null&&f[e]?this.maps[l][e].push(s):this.maps[l]={[e]:[s]},!o||o.to!=s?(o={from:s,to:s+1},t.push(o)):o.to++}),this.indexCaches[e].number=(n=(i=t[0])==null?void 0:i.from)!=null?n:this.indexCaches[e].number,this.selectedRegions[e]=t}checkIndexCache(){this.indexCaches[1].number>=this.parser.inlineTokens.length&&(this.indexCaches[1].number=Math.max(this.parser.inlineTokens.length-1,0)),this.indexCaches[0].number>=this.parser.blockTokens.length&&(this.indexCaches[0].number=Math.max(this.parser.blockTokens.length-1,0))}lookBehind(e,t){let o=this.selection.ranges,i=o.length-1,n=this.parser.getTokens(e),a=o[0].from;for(let s=this.indexCaches[e].number-1;s>=0&&a<=n[s].to;s--){for(;o[i].from>n[s].to;)i--;if(!o[i])break;o[i].to<n[s].from||t(n[s],s,i)}}lookAhead(e,t){let o=this.selection.ranges,i=0,n=this.parser.getTokens(e),a=o.at(-1).to;for(let s=this.indexCaches[e].number;s<n.length&&a>=n[s].from;s++){for(;o[i].to<n[s].from;)i++;if(!o[i])break;o[i].from>n[s].to||t(n[s],s,i)}}createFilter(e){let t=e==1?this.parser.inlineTokens:this.parser.blockTokens;if(!t.length)return this.filterRegions[e]=[Object.assign({},this.parser.lastStreamPoint)];let o=[],i=this.changedRegions[e],n=e==1?1:0;for(let a=0;a<i.length;a++){let s=i[a],l,f;s.to>t.length?(s.from>=t.length?l=this.parser.lastStreamPoint.from:l=t[s.from].from+n,f=this.parser.lastStreamPoint.to):(l=t[s.from].from+n,f=t[s.to-1].to-n),o.push({from:l,to:f})}return this.filterRegions[e]=o}mapChangedRegion(e,t,o,i){let n=this.parser.reparsedRanges[e],a=n.changedTo-n.initTo,s=[],l=n.from!=n.changedTo,f=this.parser.getTokens(e).length;if(i)return this.changedRegions[e]=f?[{from:0,to:f}]:[];if(!o||n.from==n.initTo&&!a)return this.changedRegions[e]=qt(t,this.selectedRegions[e]);if(!t.length)return l?this.changedRegions[e]=qt([{from:n.from,to:n.changedTo}],this.selectedRegions[e]):this.changedRegions[e]=this.selectedRegions[e];for(let c=0,m=!1;c<t.length;)if(t[c].to<n.from){if(s.push(Object.assign({},t[c])),++c>=t.length){l&&s.push({from:n.from,to:n.changedTo});break}}else if(t[c].from<n.initTo){m=!0;let d=Math.min(n.from,t[c].from),p=Math.max(n.changedTo,t[c].to+a);d!=p&&s.push({from:d,to:p});do c++;while(c<t.length&&t[c].from<n.initTo)}else{!m&&l&&s.push({from:n.from,to:n.changedTo});do s.push({from:t[c].from+a,to:t[c].to+a}),c++;while(c<t.length)}return this.changedRegions[e]=qt(s,this.selectedRegions[e])}iterateChangedRegion(e,t){let o=this.parser.getTokens(e),i=this.changedRegions[e],n=this.selectedRegions[e];for(let a=0,s=0;a<i.length;a++){let l=i[a];for(let f=l.from;f<l.to;f++){let c=!1;n[s]&&n[s].to<=f&&s++,n[s]&&n[s].from<=f&&(c=!0),o[f]&&(t==null||t(o[f],f,o,c))}}}iterateSelectedRegion(e,t,o){let i=this.parser.getTokens(e),n=this.selection.ranges,a=this.selectedRegions[e];for(let s=0,l=0;s<a.length;s++){let f=a[s];for(let c=f.from;c<f.to;c++){let m=i[c],d;for(let p=l-1;p>=0&&!(n[p].to<m.from);p--)n[p].from<=m.to&&(l=p);for(;m.to<n[l].from;)l++;for(;n[l]&&m.to>=n[l].from;)t&&(d!="covered"&&m.from>=n[l].from&&m.to<=n[l].to?d="covered":d!="covering"&&m.from<n[l].from&&m.to>n[l].to?d="covering":d===void 0&&(m.from==n[l].to||m.to==n[l].from)?d="adjacent":(d===void 0||d==="adjacent")&&(d="intersect")),l++;if((o==null?void 0:o(m,c,i,d))===!1)return}}}touchSelection(e,t){var a;this.checkSelectionIndexCache();let o=this.selection.ranges,i=this.indexCaches.selection,n=(a=o[i.number])!=null?a:o.at(-1);if(t<n.from){for(;i.number>=0;){if(e<=n.to&&t>=n.from)return!0;n=o[--i.number]}i.number=0}else if(e>n.to){for(;i.number<o.length;){if(e<=n.to&&t>=n.from)return!0;n=o[++i.number]}i.number=o.length-1}else return!0;return!1}pickMaps(e){let t=Ve(e)?1:0,o=this.parser.getTokens(t);return this.maps.map(i=>{var n;return(n=i[t])==null?void 0:n.filter(a=>o[a].type==e)})}clearMaps(){this.maps=new Array(this.selection.ranges.length).map(()=>({}))}checkSelectionIndexCache(){this.indexCaches.selection.number>=this.selection.ranges.length&&(this.indexCaches.selection.number=this.selection.ranges.length-1)}};var jt=class{constructor(){u(this,"isParsing",!1);u(this,"isObserving",!1);u(this,"verifier",{parse:new Set,observe:new Set})}enter(e){e.isParsing&&(this.isParsing=e.isParsing),e.isObserving&&(this.isObserving=e.isObserving)}verify(e,t,o=!1){if(this.verifier[t].has(e))return null;let i=t=="parse"?this.isParsing:this.isObserving;return o?this.reset(t):this.verifier[t].add(e),i}reset(e){this.verifier[e].clear(),e=="parse"?this.isParsing=!1:this.isObserving=!1}};var J=ni.Facet.define({combine(){return new jt},static:!0});var Ye=require("@codemirror/state"),be=require("@codemirror/view");var Ei=require("@codemirror/state");function si(r){if(r.empty)return null;let e,t,o;return r.iterChangedRanges((i,n,a,s)=>{e=e===void 0?i:Math.min(e,i),t=t===void 0?n:Math.max(t,n),o=o===void 0?s:Math.max(o,s)},!1),{from:e,initTo:t,changedTo:o,length:o-t}}function zt(r,e,t,o){let i=null;return r.iterate({from:e,to:t,enter(n){if(o(n.node))return i=n.node,!1}}),i}var ai=/(?:codeblock|html|math)-(?:begin|end)|comment-(?:start|end)|cdata|tag$/,Ue=/table|code|formatting|escape|html|math|tag|url|barelink|atom|comment|string|meta|frontmatter|internal-link|hr(?!\w)/;var li=(()=>{let r="";for(let e in mt)r+=(r?"|":"")+mt[e].query;return new RegExp(r)})();function Ko(r,e){let t=null,o=null;return r.iterate({from:e,to:e,enter(i){if(i.name=="Document")return;let n=li.exec(i.name);if(n)return t=i.node,o=n[0],!1}}),t&&o?{node:t,type:o}:null}function qo(r){var o;let e=r.name,t=0;if(r.name=="Document")return t;if(!r.name.startsWith("HyperMD")){if(r.parent.name=="Document")return t;r=r.parent}return e.startsWith("hr",8)?t=1:e.startsWith("header",8)?t=2:e.startsWith("quote",8)?t=3:e.startsWith("codeblock",8)?t=4:e.startsWith("list",8)?e.includes("nobullet")?t=6:t=5:e.startsWith("footnote",8)?(o=r.firstChild)!=null&&o.name.includes("footnote")?t=7:t=8:e.startsWith("table",8)&&(e.includes("table-row-1")?t=10:t=9),t}function Xo(r){var o;let e=r.node,t=r.type;return(e=(o=mt[t])==null?void 0:o.getOpen(e))?e.from:null}function Yo(r,e,t){return!!zt(r,e,t,i=>{let n=ai.exec(i.name);return n?!((n[0]=="math-begin"||n[0]=="math-end")&&i.to-i.from<2):!1})}function jo(r,e){let t,o,i,n;return Ve(r)?({char:t,length:o,exactLen:i}=T[r],n=!1):({char:t,length:o,exactLen:i}=z[r],n=!0),{char:t,length:o,exactLen:i,role:e,allowSpaceOnDelim:n}}function zo(r,e,t){let o=0,i=!1;for(;r[e+o]==t.char;)o++;if(t.exactLen&&o==t.length||!t.exactLen&&o>=t.length){let n;if(t.role==0)n=r[e+o];else if(t.role==1)n=r[e-1];else throw TypeError("");(t.allowSpaceOnDelim||n&&n!=" "&&n!="	")&&(i=!0)}return{valid:i,length:o}}function $o(){Ue.compile("table|code|formatting|html|math|tag|url|barelink|atom|comment|string|meta|frontmatter|hr(?!\\w)")}function We(r){let e=r.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122}function fi(r,e,t){e.closeLen=t,e.to=r.globalOffset+t,r.advance(t),r.queue.resolve([e.type],!0,!1)}function ui(){Ue.compile("table|code|formatting|escape|html|math|tag|url|barelink|atom|comment|string|meta|frontmatter|hr(?!\\w)")}function Qo(r){var n,a;let{tokens:e,ranges:t,callback:o,indexCache:i}=r;ci(e,(a=(n=t[0])==null?void 0:n.from)!=null?a:0,i);for(let s=i.number,l=0;s<e.length&&l<t.length;){if(t[l].to<=e[s].from){l++;continue}e[s].from<t[l].to&&e[s].to>t[l].from&&o(e[s]),s++}}function ci(r,e,t){if(r.length==0){t.number=0;return}t.number>=r.length&&(t.number=r.length-1);let o=t.number,i=r[o];if(e<i.from&&o!=0)do i=r[--o];while(e<i.from&&o!=0);else if(e>i.to&&o!=r.length-1)do i=r[++o];while(e>i.to&&o!=r.length-1);t.number=o}function le(r){let e={from:r.from,to:r.from+r.openLen},t={from:r.to-r.closeLen,to:r.to},o={from:e.to,to:e.to+r.tagLen},i={from:r.tagAsContent?o.from:o.to,to:t.from};return{openRange:e,closeRange:t,tagRange:o,contentRange:i}}function ht(r){let e=r.from+r.openLen,t=e+r.tagLen;return{from:e,to:t}}function $t(r,e){let t=r.offset,o=e.tagLen,i=r.lineStr;if(e.validTag){if(i[t-1]=="}")return;e.validTag=!1}if(e.tagLen==0){if(i[t]!="{")return;e.tagLen++,t++}for(let n=i[t];t<i.length&&!(!We(n)&&n!="-");n=i[++t])e.tagLen++;e.tagLen>1&&i[t]=="}"&&(e.validTag=!0,e.tagLen++),r.advance(e.tagLen-o)}function Qt(r,e){let t=r.offset,o=e.tagLen,i=r.lineStr;if(e.validTag){if(i[t-1]=="}")return;e.validTag=!1}if(e.tagLen==0){if(i[t]!="{")return;e.tagLen++,t++}for(let n=i[t];t<i.length&&!(!We(n)&&n!="-"&&n!=" ");n=i[++t])e.tagLen++;e.tagLen>1&&i[t]=="}"&&(e.validTag=!0,e.tagLen++),r.advance(e.tagLen-o)}function Zt(r,e){e.validTag=!1;let t=e.openLen+e.tagLen,o=e.tagLen,i=r.lineStr;for(;t<i.length;){let n=i[t];if(n==" "||n=="-"||We(n))e.tagLen++,t++;else break}r.advance(e.tagLen-o),t>=i.length?e.validTag=!0:r.queue.resolve([e.type],!1,!1)}var mi=require("@codemirror/state");function Zo(r,e){let t=e instanceof mi.Line?e:r.lineAt(e),o=t.number>1?r.line(t.number-1):null;if(N(t))return t;for(;o&&!N(o);)t=o,o=t.number>1?r.line(t.number-1):null;return t}var hi=require("@codemirror/state");function di(r,e){let t;return e instanceof hi.Line?t=e.number:t=r.lineAt(e).number,t<=1?null:r.line(t-1)}var pi=require("@codemirror/state");function dt(r,e,t=!0){let o=e instanceof pi.Line?e:r.lineAt(e);for(;o.number<r.lines;)if(o=r.line(o.number+1),N(o)){t||(o=r.line(o.number-1));break}return o}function N(r){return!r.text.trimEnd()}function Jo(r,e,t){return e-=r.from,t-=r.from,r.text.slice(e,t)}function pt(r,e,t){if(!t)return r.lineAt(e);t.number>r.lines&&(t.number=r.lines);let o=r.line(t.number);if(e<o.from)do o=r.line(o.number-1);while(e<o.from);else if(e>o.to)do o=r.line(o.number+1);while(e>o.to);return t.number=o.number,o}function Jt(r){var e;for(let t=r.fromLn;t<=((e=r.toLn)!=null?e:r.doc.lines);t++){let o=r.doc.line(t);if(r.callback(o,r.doc)===!1)break}}function gi(r,e,t=!1,o=!1){let i=[],n=r.lineAt(e.from),a=n,s;for(!N(n)&&t&&(s={start:Zo(r,n).number,end:n.number+1},i.push(s));e.to>=n.from&&(N(n)?s=void 0:s?s.end++:(s={start:n.number,end:n.number+1},i.push(s)),!(n.number>=r.lines));n=r.line(n.number+1));return s&&o&&(s.end=dt(r,n,!1).number+1),i.length||i.push({start:a.number,end:a.number+1}),i}var Si=require("@codemirror/state");function vi(r,e){let t=e instanceof Si.Line?e:r.lineAt(e);return t.number>=r.lines?null:r.line(t.number+1)}function bi(r,e){let t=di(r,e);return!t||N(t)}function Ti(r,e){let t=vi(r,e);return!t||N(t)}var eo=class{constructor(e){u(this,"state");u(this,"queue",new oo);u(this,"inlineTokens",[]);u(this,"blockTokens",[]);u(this,"reparsedRanges");u(this,"lastStreamPoint",{from:0,to:0});u(this,"settings");this.settings=e,e.editorEscape||$o()}getTokens(e){return e==1?this.inlineTokens:this.blockTokens}initParse(e,t){this.settings.editorEscape?ui():$o(),this.lastStreamPoint.from=0,this.inlineTokens=[],this.blockTokens=[],this.defineState({doc:e,tree:t,offset:0,settings:this.settings}),this.streamParse(),this.reparsedRanges={1:{from:0,initTo:0,changedTo:this.inlineTokens.length},0:{from:0,initTo:0,changedTo:this.blockTokens.length}}}applyChange(e,t,o,i){let n=si(i),a=Math.min(o.length,t.length)+1;n&&(a=Math.min(a,n.from));let s={doc:e,tree:t,offset:a,settings:this.settings};this.defineState(s,o);let l=n&&!this.checkInterferer(o,n)?dt(e,n.changedTo):dt(e,t.length),f={inline:this.getReusedTokens(this.filterTokens(this.inlineTokens,this.reparsedRanges[1]),n,l),block:this.getReusedTokens(this.filterTokens(this.blockTokens,this.reparsedRanges[0]),n,l)};this.shiftOffset(),this.mapReusedTokens(f.inline,n),this.mapReusedTokens(f.block,n),this.state.endOfStream=l.number,this.streamParse(),this.reparsedRanges[1].changedTo=this.inlineTokens.length,this.reparsedRanges[0].changedTo=this.blockTokens.length,this.inlineTokens=this.inlineTokens.concat(f.inline),this.blockTokens=this.blockTokens.concat(f.block)}defineState(e,t){this.state=new to(e,this.inlineTokens,this.blockTokens),this.queue.attachState(this.state),t&&this.shiftOffsetByNode(t)}shiftOffsetByNode(e){let t=this.state.globalOffset,o=Ko(this.state.tree,t),i=Ko(e,t),n=null;if(o&&(n=Xo(o)),i){let a=Xo(i);a!==null&&(n===null||a<n)&&(n=a)}return n!==null?(this.state.setGlobalOffset(n),!0):!1}shiftOffset(){if(this.state.offset==0)return!1;let e=this.state.offset-1,t=this.state.lineStr,o=t[e];if(o=="+"||o=="|"||o=="^"||o=="~"||o=="="||o=="!"||o==":"){for(;t[e-1]==o;)e--;return this.state.offset=e,!0}return!1}removeState(){this.queue.detachState(),this.state=void 0}streamParse(){let e,t=this.state;this.lastStreamPoint.from=t.globalOffset,(e=this.state.prevLine)&&t.setContext(t.getContext(e)),t.trySkipBlankLine()||t.resolveContext();do this.parseLine();while(t.advanceLine());this.lastStreamPoint.to=t.globalOffset,this.queue.clear(),this.removeState()}parseLine(){let e=this.state;for(this.settings.fencedDiv&2&&this.state.offset==0&&e.blkStart&&er.block(e,7);;){e.isSpace()&&e.queue.resolve(B.SPACE_RESTRICTED_INLINE,!1,!1);let t=e.processCursor(),o=K[e.char];if(t=="skipped")e.skipCursorRange();else if(t=="table_sep")e.queue.resolve(B.ALL_INLINE,!1,!1),e.advance();else if(o&&(o!=5||t=="hl_delim"))er.inline(e,o);else if(!e.advance())break}}checkInterferer(e,t){return Yo(this.state.tree,t.from,t.changedTo)||Yo(e,t.from,t.initTo)}filterTokens(e,t){let o=0,i,n,a=this.state.globalOffset;for(let s=e[o];o<e.length;s=e[++o]){if(s.to<a)continue;let{openRange:l,tagRange:f}=le(s);if(l.to<a)s.to=s.from,s.closeLen=0,i!=null||(i=o),this.queue.push(s),s.tagLen&&f.to>=a&&(s.tagLen=a-f.from,s.type==5?$t(this.state,s):s.type==6?Qt(this.state,s):s.type==7&&Zt(this.state,s));else{n=o+1;break}}return i!=null||(i=o),t.from=i,t.initTo=n!=null?n:o,e.splice(o)}getReusedTokens(e,t,o){let i=0,n=t==null?void 0:t.length;if(n===void 0)return[];for(;i<e.length&&e[i].to<=o.to-n;)i++;return e.slice(i)}mapReusedTokens(e,t){if(!e||!t)return;let o=t.changedTo-t.initTo;for(let i=0,n=e[i];i<e.length;n=e[++i])n.from+=o,n.to+=o}};var to=class{constructor(e,t,o){u(this,"doc");u(this,"tree");u(this,"cursor");u(this,"line");u(this,"blkStart");u(this,"endOfStream");u(this,"offset");u(this,"inlineTokens");u(this,"blockTokens");u(this,"queue");u(this,"curCtx",0);u(this,"prevCtx",0);u(this,"settings");this.doc=e.doc,this.tree=e.tree,this.line=this.doc.lineAt(e.offset),this.endOfStream=this.doc.lineAt(this.tree.length).number,this.offset=e.offset-this.line.from,this.inlineTokens=t,this.blockTokens=o,this.cursor=this.tree.cursor(),this.settings=e.settings,this.nextCursor();let i=this.prevLine;i?this.blkStart=N(i):this.blkStart=!0}get globalOffset(){return this.offset+this.line.from}get linePos(){return this.line.number}get lineStr(){return this.line.text}get char(){let e=this.line.text[this.offset];return!e&&!this.isLastLine()?`
`:e!=null?e:""}get prevLine(){let e=this.linePos;return e==1?null:this.doc.line(e-1)}advance(e=1){let t=this.lineStr.length-this.offset;return t?(e>t?this.offset+=t:this.offset+=e,!0):(this.queue.resolve(B.SPACE_RESTRICTED_INLINE,!1,!1),!1)}setGlobalOffset(e){e>this.doc.length?(this.line=this.doc.line(this.doc.lines),this.offset=this.line.to):(this.line=this.doc.lineAt(e),this.offset=e-this.line.from)}isSpace(e=0){let t=this.lineStr[this.offset+e];return t==" "||t=="	"||!t}seekWhitespace(e=this.line.length){let t=this.offset;for(let o=this.line.text[t];t<e;o=this.line.text[++t])if(o==" "||o=="	")return t;return null}advanceLine(e=!0){return this.linePos>=this.endOfStream?(this.queue.resolveAll(!1),null):(this.line=this.doc.line(this.linePos+1),this.offset=0,this.blkStart=!1,this.resolveContext(),e&&this.trySkipBlankLine(),this.line)}trySkipBlankLine(){if(this.isBlankLine()){for(this.blkStart=!0,this.queue.resolveAll(!0,this.line.to);this.linePos<this.endOfStream&&(this.line=this.doc.line(this.linePos+1),!!this.isBlankLine()););return this.resolveContext(),!0}return!1}isLastLine(){return this.line.number>=this.doc.lines}isBlankLine(){return N(this.line)}nextCursor(e=!0){if(this.cursor){if(this.cursor.next(e)&&this.cursor.name!="Document")return!0;this.cursor=null}return!1}cursorPos(e=0){let t=this.globalOffset;return this.cursor?t<this.cursor.from?"after":t>this.cursor.to+e?"before":"touch":null}processCursor(){let e=this.cursorPos(-1);for(;e=="before";)this.nextCursor(),e=this.cursorPos(-1);if(e!="touch")return null;let t=this.cursor.name;return t.includes("formatting-highlight")?"hl_delim":t.includes("table-sep")?"table_sep":Ue.test(t)?"skipped":null}skipCursorRange(){if(!this.cursor)return!1;let e=this.cursor.to-this.line.from,t=this.seekWhitespace(e);return t!==null&&(this.offset=t,this.queue.resolve(B.SPACE_RESTRICTED_INLINE,!1,!1)),this.offset=e,!0}getContext(e=this.line){if(e.number!=this.linePos){let t=zt(this.tree,e.from,e.from,o=>{var i;return((i=o.parent)==null?void 0:i.name)=="Document"});if(t)return qo(t)}else if(this.cursorPos()=="touch"){let t=this.cursor.node;return qo(t)}return 0}setContext(e){this.prevCtx=this.curCtx,this.curCtx=e}resolveContext(){for(;this.cursorPos()=="before";)this.nextCursor();this.setContext(this.getContext());let e=!1,t=!1,o=!1,i=this.line.from;switch(this.curCtx){case 1:case 4:case 10:e=!0,t=!0;break;case 3:this.prevCtx!=3&&(t=!0);break;case 5:o=!0;case 2:case 7:t=!0;break}switch(this.prevCtx){case 2:case 9:t=!0,i-=1}this.offset||(t&&(this.queue.resolve(B.ALL_BLOCK,!1,!1,i),this.queue.resolve(B.NON_BUILTIN_INLINE,!1,!1,i),this.blkStart=!0),o&&this.queue.resolve([5],!1,!1,i)),e&&this.skipCursorRange(),this.curCtx&&this.nextCursor()}};var er={block(r,e){if(!r.blkStart)return!1;let t=jo(e,0),{valid:o,length:i}=zo(r.lineStr,r.offset,t);if(r.advance(i),!o)return!1;let n={type:e,level:0,status:0,from:r.globalOffset-i,to:r.globalOffset-i,openLen:i,closeLen:0,tagLen:0,tagAsContent:!1,validTag:!1,closedByBlankLine:!1};return r.blockTokens.push(n),r.queue.push(n),Zt(r,n),!0},inline(r,e){let t=r.queue.getToken(e),o=r.queue.isQueued(e)?1:0,i=jo(e,o),n=e==5,a=e==6,{valid:s,length:l}=zo(r.lineStr,r.offset,i);if(!s)return r.advance(l),!1;if(t)fi(r,t,l);else{let f={type:e,level:1,status:0,from:r.globalOffset,to:r.globalOffset,openLen:l,closeLen:0,tagLen:0,tagAsContent:n||a,validTag:!1,closedByBlankLine:!1};r.inlineTokens.push(f),r.queue.push(f),r.advance(l),n?$t(r,f):a&&Qt(r,f)}return!0}};var oo=class{constructor(){u(this,"tokenMap",{});u(this,"state")}attachState(e){this.state=e,this.state.queue=this}detachState(){this.state.queue=void 0,this.state=void 0}isQueued(e){return!!this.tokenMap[e]}push(e){e.status=0,this.tokenMap[e.type]=e}getToken(e){var t;return(t=this.tokenMap[e])!=null?t:null}resolve(e,t,o,i=this.state.globalOffset){for(let n of e){let a=this.getToken(n);a&&(a.level==1?!t&&T[n].mustBeClosed?a.status=2:a.status=1:a.validTag?a.status=1:a.status=2,t||(a.to=i,a.closedByBlankLine=o),delete this.tokenMap[n])}}resolveAll(e,t=this.state.globalOffset){this.resolve(B.ALL,!1,e,t)}clear(){this.tokenMap={}}};var ro=require("@codemirror/language"),Ii=require("@lezer/common");var Ci=require("@codemirror/state"),Re=Ci.Annotation.define();var qe=Ei.StateField.define({create(r){let e=new eo(r.facet(Be.reader)),t=r.facet(J);return e.initParse(r.doc,(0,ro.syntaxTree)(r)),t.enter({isParsing:!0}),e},update(r,e){let t=(0,ro.syntaxTree)(e.startState),o=(0,ro.syntaxTree)(e.state),i=e.annotation(Re),n=e.state.facet(J);return e.effects.forEach(a=>{var l;let s=(l=a.value)==null?void 0:l.tree;s instanceof Ii.Tree&&(o=s)}),i?(r.initParse(e.newDoc,o),n.enter({isParsing:!0}),r):((e.docChanged||t.length!=o.length)&&(r.applyChange(e.newDoc,o,t,e.changes),n.enter({isParsing:!0})),r)}});var wi=require("@codemirror/state");var Se=wi.StateField.define({create(r){let e=new Yt(r.field(qe)),t=r.facet(J);return e.observe(r.selection,!0),t.enter({isObserving:!0}),e},update(r,e){let t=!(e.selection&&e.startState.selection.eq(e.selection)),o=e.state.facet(J),i=o.verify(r,"parse");return e.isUserEvent("select"),(i||t)&&(r.observe(e.newSelection,i!=null?i:!1),o.enter({isObserving:!0})),r}});var Ai=require("@codemirror/state");var Xe=require("@codemirror/state"),gt=require("@codemirror/view");var xi=require("@codemirror/view"),yi=xi.Decoration.mark({class:"cm-spoiler-revealed"});var io=require("@codemirror/view");var Le=class r extends io.WidgetType{constructor(t){super();u(this,"token");this.token=t}eq(t){return t.token==this.token}toDOM(){return document.createElement("span")}static of(t,o,i,n=!1){return io.Decoration.replace({widget:new r(i),block:n,inclusiveEnd:!1}).range(t,o)}};var so=require("@codemirror/view");var Li=require("@codemirror/view"),Pi=require("obsidian");function ki(r){return Di(r)?r.workspace.activeEditor:null}function Oi(r){let e=ki(r),t=e==null?void 0:e.containerEl;return t?t.getBoundingClientRect():null}function Di(r){var e;return((e=r.workspace.getMostRecentLeaf())==null?void 0:e.view.getViewType())=="canvas"}var tr=require("obsidian");function Ri(r,e){let t=r.field(tr.editorLivePreviewField),o=e.field(tr.editorLivePreviewField);return t!=o}var q=class extends Pi.Menu{constructor(t,o){super();u(this,"itemIndexCache",{number:0});u(this,"view");u(this,"type");u(this,"formatter");u(this,"settings");u(this,"CLS_PREFIX","ems-menu-item");u(this,"ICON");this.constructMenu(t,o)}constructMenu(t,o){this.view=t,this.type=o,this.formatter=t.plugin(L).formatter,this.settings=t.state.facet(Be),this.bindIndexCache(),this.setClassPrefix(),this.setIcon(),this.addConfigs(this.getConfigs()),this.addDefaultItem(),this.addRemoveItem(),this.dom.addClass("ems-menu","ems-tag-menu"),o==5&&this.dom.addClass("ems-color-menu")}setClassPrefix(){this.type==5?this.CLS_PREFIX+=" ems-highlight-":this.type==6?this.CLS_PREFIX+=" ems-span-":this.type==7&&(this.CLS_PREFIX+=" ems-div-")}setIcon(){this.type==5?this.ICON="palette":this.ICON="shapes"}bindIndexCache(){let{indexCache:t}=this.view.plugin(L);switch(this.type){case 5:this.itemIndexCache=t.colorMenuItem;break;case 6:this.itemIndexCache=t.spanTagMenuItem;break;case 7:this.itemIndexCache=t.divTagMenuItem;break;default:this.itemIndexCache={number:0}}}getConfigs(){let t=[];return this.type==5?t=this.settings.colorConfigs:this.type==6?t=this.settings.predefinedSpanTag:this.type==7&&(t=this.settings.predefinedDivTag),t}addConfigs(t){t.forEach(({name:o,tag:i,showInMenu:n})=>{n&&this.addConfigItem(o,this.ICON,this.CLS_PREFIX+i,()=>{this.format(i)})}),this.type==5&&this.settings.showAccentColor&&this.addConfigItem("Accent",this.ICON,this.CLS_PREFIX+"accent",()=>{this.format("accent")})}addConfigItem(t,o,i,n){this.addItem(a=>{a.setTitle(t),a.setIcon(o),a.dom.addClass(...i.split(" ")),a.onClick(s=>{let l=this.items.findIndex(f=>f==a);this.itemIndexCache.number=l,n(s)})})}addDefaultItem(){(this.type==5&&this.settings.showDefaultColor||this.type==6&&this.settings.showDefaultSpanTag)&&this.addConfigItem("Default",this.ICON,this.CLS_PREFIX+"default",()=>{this.format("")})}addRemoveItem(){(this.type==5&&this.settings.showRemoveColor||this.type==6&&this.settings.showRemoveSpanTag)&&this.addConfigItem("Remove","eraser","ems-menu-item ems-remove",()=>{this.removeFormatting()})}format(t){this.formatter.startFormat(this.type,t)}removeFormatting(){this.formatter.startFormat(this.type,void 0,!0)}showMenu(){this.checkItemIndexCache(),this.view.requestMeasure({read:t=>{let o=t.state.facet(Wt.reader),i=Oi(o),n=t.state.selection.ranges.at(-1).to,a=t.coordsForChar(n);if(!a){let s=t.contentDOM.getBoundingClientRect(),l=t.lineBlockAt(n),f=t.textDirection==Li.Direction.RTL;a={top:s.top,bottom:s.top+l.height,left:f?s.right:s.left,right:f?s.left:s.right}}return{charCoords:a,canvasNodeCoords:i}},write:t=>{let{charCoords:o,canvasNodeCoords:i}=t;if(o){let n={x:o.left,y:o.bottom};i&&(n.x+=i.x,n.y+=i.y),this.showAtPosition(n),this.select(this.itemIndexCache.number)}}})}checkItemIndexCache(){this.itemIndexCache.number>=this.items.length&&(this.itemIndexCache.number=this.items.length-1)}static bindMenu(t,...o){let i=["addConfigItem","addConfigs","bindIndexCache","checkItemIndexCache","constructMenu","format","removeFormatting","showMenu","setClassPrefix","setIcon","addDefaultItem","addRemoveItem","getConfigs"];for(let n of i)Object.defineProperty(t,n,{value:this.prototype[n].bind(t)});return Object.defineProperty(t,"CLS_PREFIX",{value:"ems-menu-item",configurable:!0,writable:!0}),t.constructMenu(...o),t}static create(...t){let[o,i]=t;if(!Oe(i))throw new TypeError("This format type doesn't support custom tag.");return new this(o,i)}};var no=class r extends so.WidgetType{constructor(t){super();u(this,"menu");u(this,"btnPos");u(this,"colorMenu");this.btnPos=t.from+t.openLen}eq(t){return this.btnPos==t.btnPos}toDOM(t){let o=document.createElement("span");return o.setAttribute("aria-hidden","true"),o.className="cm-highlight-color-btn",o.onclick=()=>{t.dispatch({selection:{anchor:this.btnPos}}),this.colorMenu||(this.colorMenu=q.create(t,5)),this.colorMenu.showMenu()},o}ignoreEvent(){return!1}static of(t){let o=t.from+t.openLen;return so.Decoration.widget({widget:new r(t),side:1}).range(o)}};var lo=require("@codemirror/view");var ao=class r extends lo.WidgetType{constructor(t){super();u(this,"offset");this.offset=t}eq(t){return t.offset===this.offset}toDOM(){return document.createElement("br")}static of(t){return lo.Decoration.replace({widget:new r(t)}).range(t-1,t)}};var Fn=require("@codemirror/view");var Ni=require("@codemirror/view");function Mi(r,e){return Ni.Decoration.mark({class:e,token:r}).range(r.from,r.to)}var _i=require("@codemirror/view");function or(r,e,t){return _i.Decoration.line({class:e,token:r}).range(t.from)}var St=require("obsidian");var fo=class{constructor(e,t){u(this,"parser");u(this,"omitter");u(this,"catcher");u(this,"lineBreakReplacer");u(this,"selectionObserver");u(this,"holder");u(this,"settings");u(this,"indexCaches",{linePos:{number:1},inlineToken:{number:0},blockToken:{number:0}});this.parser=e,this.selectionObserver=t,this.settings=e.settings,this.omitter=new uo(this.settings,t),this.catcher=new co,this.lineBreakReplacer=new mo(e),this.holder=new ho}buildMain(e,t){this.buildInline(t,e.visibleRanges),this.buildBlock(t,e.visibleRanges)}buildSupplementary(e){e?(this.omitInlineDelim(this.catcher.activeTokens),this.createColorBtnWidgets(this.catcher.hlTokens),this.revealSpoiler(this.catcher.spoilerTokens)):this.holder.colorBtnSet=this.holder.revealedSpoilerSet=Xe.RangeSet.empty}onViewInit(e){let t=e.state,o=t.field(St.editorLivePreviewField);this.buildMain(e,t),this.buildSupplementary(o)}onViewUpdate(e){let t=e.state,o=e.view,i=t.field(St.editorLivePreviewField),n=t.facet(J);(n.verify("builder-view-update","parse",!0)||e.viewportMoved)&&this.buildMain(o,t),(n.verify("builder-view-update","observe",!0)||e.viewportMoved)&&this.buildSupplementary(i)}onStateInit(e){e.field(St.editorLivePreviewField)&&this.omitFencedDivOpening(),this.replaceLineBreaks(e.doc)}onStateUpdate(e){let t=e.state,o=t.field(St.editorLivePreviewField),i=e.annotation(Re),n=Ri(t,e.startState),a=t.facet(J);a.verify("builder-state-update","parse")&&this.replaceLineBreaks(e.newDoc,e.changes),(n||i)&&(this.selectionObserver.restartObserver(e.newSelection,e.docChanged),this.holder.blockOmittedSet=Xe.RangeSet.empty),o?(a.verify("builder-state-update","observe")||n)&&this.omitFencedDivOpening(e.changes):this.removeOmitter()}buildInline(e,t){let o=[],i=[],n=[],a=[];return Qo({tokens:this.parser.inlineTokens,ranges:t,indexCache:this.indexCaches.inlineToken,callback:s=>{s.status==1&&(s.type==5&&n.push(s),s.type==2&&a.push(s),o.push(this.transformInlineToken(s,e.doc)),i.push(s))}}),this.catcher.catch(i,n,a),this.holder.inlineSet=gt.Decoration.set(o)}buildBlock(e,t){let o=[];return Qo({tokens:this.parser.blockTokens,ranges:t,indexCache:this.indexCaches.blockToken,callback:i=>{i.status==1&&o.push(...this.transformBlockToken(i,e.doc))}}),this.holder.blockSet=gt.Decoration.set(o)}transformInlineToken(e,t){let o="cm-"+T[e.type].class;if(e.tagLen){let i=pt(t,e.from,this.indexCaches.linePos),n=ht(e),a=Jo(i,n.from+1,n.to-1);e.type==6?(a=Ie(a),o+=" "+a):o+=" "+o+"-"+a}return Mi(e,o)}transformBlockToken(e,t){let o="cm-"+z[e.type].class,i=pt(t,e.from,this.indexCaches.linePos),n=ht(e),a=Ie(Jo(i,n.from,n.to)),s=o+" cm-fenced-div-start",l=o+" "+a,f=[or(e,s,i)];return Jt({doc:t,fromLn:i.number+1,callback(c){if(c.to>e.to||c.to==e.to&&!c.text.trimEnd())return!1;let m=or(e,l,c);f.push(m)}}),f}createColorBtnWidgets(e){if(!this.settings.colorButton)return this.holder.colorBtnSet=Xe.RangeSet.empty;let t=[];for(let o=0;o<e.length;o++){let i=e[o];this.selectionObserver.touchSelection(i.from,i.to)&&t.push(no.of(i))}return this.holder.colorBtnSet=gt.Decoration.set(t)}revealSpoiler(e){let t=[];for(let o=0;o<e.length;o++){let i=e[o];this.selectionObserver.touchSelection(i.from,i.to)&&t.push(yi.range(i.from,i.to))}return this.holder.revealedSpoilerSet=gt.Decoration.set(t)}omitInlineDelim(e){return this.holder.inlineOmittedSet=this.omitter.omitInline(e)}replaceLineBreaks(e,t){return this.holder.lineBreaksSet=this.lineBreakReplacer.replace(e,t)}omitFencedDivOpening(e){return this.settings.alwaysShowFencedDivTag&2?this.holder.blockOmittedSet=Xe.RangeSet.empty:this.holder.blockOmittedSet=this.omitter.omitBlock(this.holder.blockOmittedSet,e)}removeOmitter(){this.holder.inlineOmittedSet=this.holder.blockOmittedSet=Xe.RangeSet.empty}};var rr=require("@codemirror/view");var uo=class{constructor(e,t){u(this,"selectionObserver");u(this,"settings");this.settings=e,this.selectionObserver=t}omitBlock(e,t){let o=[],i=this.selectionObserver.filterRegions[0];if(this.selectionObserver.iterateChangedRegion(0,(n,a,s,l)=>{if(l||n.status!=1||!n.validTag)return;let f=n.from,c=f+n.openLen+n.tagLen;n.to>c&&c++,o.push(Le.of(f,c,n,!0))}),!(e!=null&&e.size))e=rr.Decoration.set(o);else{t&&(e=e.map(t));for(let n=0;n<i.length;n++){let a=i[n];e=e.update({filterFrom:a.from,filterTo:a.to,filter:()=>!1})}e=e.update({add:o})}return e}omitInline(e){let t=this.settings.hlTagDisplayBehaviour&0,o=this.settings.spanTagDisplayBehaviour&0,i=this.settings.hlTagDisplayBehaviour&1,n=this.settings.spanTagDisplayBehaviour&1,a=[];for(let s=0;s<e.length;s++){let l=e[s],f=l.from,c=f+l.openLen,m=c+l.tagLen;this.selectionObserver.touchSelection(l.from,l.to)?l.validTag&&!this.selectionObserver.touchSelection(c,m)&&(l.type==5&&i||l.type==6&&n)&&a.push(Le.of(c,m,l)):((l.type==5&&!t||l.type==6&&!o)&&(c=m),a.push(Le.of(f,c,l)),l.closeLen&&a.push(Le.of(l.to-l.closeLen,l.to,l)))}return rr.Decoration.set(a,!0)}};var co=class{constructor(){u(this,"activeTokens",[]);u(this,"hlTokens",[]);u(this,"spoilerTokens",[])}catch(e,t,o){this.activeTokens=e,this.hlTokens=t,this.spoilerTokens=o}empty(){this.activeTokens=[],this.hlTokens=[],this.spoilerTokens=[]}};var ir=require("@codemirror/state");var mo=class{constructor(e){u(this,"linePosCache",{number:1});u(this,"parser");u(this,"lineBreakSet",ir.RangeSet.empty);this.parser=e}replace(e,t){var a,s;let o=this.parser.reparsedRanges[0],i=this.parser.blockTokens,n={add:this.produceWidgetRanges(e)};return i.length?((o.from!=o.initTo||o.from!=o.changedTo)&&(n.filterFrom=Math.min((s=(a=i[o.from])==null?void 0:a.from)!=null?s:this.parser.lastStreamPoint.from,this.parser.lastStreamPoint.from),n.filterTo=this.parser.lastStreamPoint.to,n.filter=()=>!1),t&&(this.lineBreakSet=this.lineBreakSet.map(t)),this.lineBreakSet=this.lineBreakSet.update(n)):this.lineBreakSet=ir.RangeSet.empty}getReparsedBlockTokens(){let e=this.parser.reparsedRanges[0];return this.parser.blockTokens.slice(e.from,e.changedTo)}produceWidgetRanges(e){let t=this.getReparsedBlockTokens(),o=[];if(!t.length)return o;let i=pt(e,t[0].from,this.linePosCache),n=0;return Jt({doc:e,fromLn:i.number,callback:a=>{let s=t[n];if(!s)return!1;if(s.status!=1){n++;return}if(!(a.from==s.from||a.from-1==s.from+s.openLen+s.tagLen)){if(a.from>=s.to||a.to<s.from||a.to==s.to&&s.closedByBlankLine){n++;return}o.push(ao.of(a.from))}}}),o}};var ve=require("@codemirror/state");var ho=class{constructor(){u(this,"inlineSet",ve.RangeSet.empty);u(this,"blockSet",ve.RangeSet.empty);u(this,"inlineOmittedSet",ve.RangeSet.empty);u(this,"blockOmittedSet",ve.RangeSet.empty);u(this,"colorBtnSet",ve.RangeSet.empty);u(this,"revealedSpoilerSet",ve.RangeSet.empty);u(this,"lineBreaksSet",ve.RangeSet.empty)}};var Pe=Ai.StateField.define({create(r){let e=r.field(qe),t=r.field(Se),o=new fo(e,t);return o.onStateInit(r),o},update(r,e){return r.onStateUpdate(e),r}});var Fi=require("@codemirror/state");var nr=require("@codemirror/view"),Hi=Fi.StateField.define({create(r){let e=r.field(Pe).holder;return{lineBreaksSet:e.lineBreaksSet,blockOmittedSet:e.blockOmittedSet}},update(r,e){let t=e.state.field(Pe).holder;return t.lineBreaksSet===r.lineBreaksSet&&t.blockOmittedSet===r.blockOmittedSet?r:{lineBreaksSet:t.lineBreaksSet,blockOmittedSet:t.blockOmittedSet}},provide(r){return[nr.EditorView.decorations.from(r,e=>e.blockOmittedSet),nr.EditorView.decorations.from(r,e=>e.lineBreaksSet)]}});var vt=require("@codemirror/state");function sr(r,e){return r.startsWith(e)&&r.endsWith(e)}var po=class{constructor(e){u(this,"view");u(this,"state");u(this,"parser");u(this,"selectionObserver");u(this,"settings");this.view=e,this.selectionObserver=e.state.field(Se),this.parser=this.selectionObserver.parser,this.settings=this.parser.settings}get doc(){return this.view.state.doc}defineState(e,t){this.state=new go(e,this.doc,this.selectionObserver,this.settings,t)}clearState(){this.state=void 0}startFormat(e,t,o,i){var a;o&&(t=void 0),this.settings.openTagMenuAfterFormat||(i=!1);let n=this.selectionObserver.pickMaps(e);if(n.length==1&&!((a=n[0])!=null&&a.length)&&i){q.create(this.view,e).showMenu();return}this.defineState(e,t),o?this.removeAll():this.state.level==1?this.formatInline():this.formatBlock(),this.composeChanges(),this.remapSelection(),this.dispatchToView()}formatInline(){let e=this.state,t=this.state.tokens;do{let{curTokenMap:o,curRange:i,tagStr:n,precise:a}=e,s=o?t[o[0]]:null;a?s?s.from>i.from||s.to<i.to?this.extend():s.status!=1?this.close(s):n!==void 0?this.changeInlineTag(s):i.empty?this.remove(s):this.breakApart(s):this.wrap():this.toggleInlineDelim()}while(e.advance())}formatBlock(){do this.toggleBlockTag();while(this.state.advance())}wrap(e=!0){var n,a;let{curRange:t,delimStr:o,tagStr:i}=this.state;if(t.empty){let s=t.from;if(e&&(t=(n=this.view.state.wordAt(t.from))!=null?n:t),s==t.to){let l=o.length;s==t.from&&(l+=(a=i==null?void 0:i.length)!=null?a:0),this.state.pushSelectionShift(this.state.curSelectionIndex,l)}}this.state.pushChange([{from:t.from,insert:o+(i!=null?i:"")},{from:t.to,insert:o}])}close(e){let{delimStr:t,tagStr:o}=this.state;Oe(e.type)&&o&&this.state.pushChange({from:e.from+e.openLen,insert:o}),this.state.pushChange({from:e.to,insert:t})}breakApart(e){let{openRange:t,tagRange:o,closeRange:i}=le(e),{curRange:n,delimStr:a}=this.state,s=this.doc.sliceString(o.from,o.to);Wo(n.from,t)?this.state.pushChange(t):this.state.pushChange({from:n.from,insert:a}),Wo(n.to,i)?this.state.pushChange(i):this.state.pushChange({from:n.to,insert:a+s})}changeInlineTag(e){let{tagRange:t}=le(e),{tagStr:o,curRange:i,curSelectionIndex:n}=this.state;o!==void 0&&(e.validTag||(t.to=t.from),this.state.pushChange({from:t.from,to:t.to,insert:o}),i.empty&&i.from==t.from&&this.state.pushSelectionShift(n,o.length))}extend(){let{curRange:e,delimStr:t,tagStr:o,curTokenMap:i,mappedTokens:n}=this.state,a=this.parser.getTokens(this.state.level),s=i==null?void 0:i[0],l=i==null?void 0:i.at(-1),f=n[0],c=n[n.length-1],m=!1,d={from:s!=null?s:0,to:(l!=null?l:0)+1};if(f&&f.from<=e.from){let{tagRange:p,closeRange:b}=le(f);d.from++,o!==void 0&&this.state.pushChange(f.validTag?{from:p.from,to:p.to,insert:o}:{from:p.from,insert:o}),this.state.pushChange(b)}else this.state.pushChange({from:e.from,insert:t});c&&c.to>=e.to&&(m=!0,d.to--);for(let p=d.from;p<d.to;p++){let b=i==null?void 0:i[p];b!==void 0&&this.remove(a[b])}if(m){let{openRange:p,tagRange:b}=le(c);this.state.pushChange(p),c.validTag&&this.state.pushChange(b),c.status!=1&&this.state.pushChange({from:e.to,insert:t})}else this.state.pushChange({from:e.to,insert:t})}toggleInlineDelim(){let{curRange:e,delimStr:t}=this.state,o=t.length,i=this.doc.sliceString(e.from-o,e.to+o),n=i.slice(o,-o);sr(n,t)?this.state.pushChange([{from:e.from,to:e.from+o},{from:e.to-o,to:e.to}]):sr(i,t)?this.state.pushChange([{from:e.from-o,to:e.from},{from:e.to,to:e.to+o}]):this.wrap(!1)}addBlockTag(e){var s;let{doc:t}=this,{delimStr:o}=this.state,i=t.line(e.start),n=t.line(e.end-1),a=(s=this.state.tagStr)!=null?s:"";bi(t,i)||(o=`
`+o),this.state.pushChange({from:i.from,insert:o+a}),Ti(t,n)||this.state.pushChange({from:n.to,insert:`
`})}changeBlockTag(e){let{tagRange:t}=le(e),{tagStr:o}=this.state;this.state.pushChange({from:t.from,to:t.to,insert:o})}toggleBlockTag(){let e=this.doc,t=gi(e,this.state.curRange),{mappedTokens:o,tagStr:i}=this.state;for(let n=0,a=0;n<t.length;n++){let s=t[n],l=o[a],f=e.line(s.start),c=l?ht(l):void 0;!l||f.from<l.from?this.addBlockTag(s):l.status!=1||f.from>c.to+1?(this.addBlockTag(s),a++):i===void 0?(this.remove(l),a++):(this.changeBlockTag(l),a++)}}remove(e){let{openRange:t,tagRange:o,closeRange:i}=le(e),n=[t,o,i];e.validTag||n.remove(o),e.level==0&&e.to>o.to&&o.to++,this.state.pushChange(n)}removeAll(){do{let{mappedTokens:e}=this.state;e.forEach(t=>{this.remove(t)})}while(this.state.advance())}composeChanges(){return this.state.changeSet=vt.ChangeSet.of(this.state.changes,this.state.docLen)}remapSelection(){var i;let{selectionRanges:e,changeSet:t,selectionShift:o}=this.state;for(let n=0;n<e.length;n++){let a=e[n].map(t),s=(i=o[n])==null?void 0:i.shift;s&&(a=vt.EditorSelection.range(a.to+s,a.from+s)),e[n]=a}return this.state.remappedSelection=vt.EditorSelection.create(e)}dispatchToView(){let{changeSet:e,remappedSelection:t}=this.state;this.view.dispatch({changes:e},{selection:t,sequential:!0}),this.clearState()}};function Gi(r,e){for(let t=0;t<r.ranges.length;t++){let o=Bi(r.ranges[t],e);r=r.replaceRange(o,t)}return r}var ar=require("@codemirror/state");function Bi(r,e){let t=e.sliceString(r.from,r.to),o=t.length-t.trimStart().length,i=t.length-t.trimEnd().length;return t.length==o?ar.EditorSelection.cursor(r.from):ar.EditorSelection.range(r.from+o,r.to-i)}var go=class{constructor(e,t,o,i,n){u(this,"docLen");u(this,"tokens");u(this,"selectionRanges");u(this,"curSelectionIndex",0);u(this,"tokenMaps");u(this,"curTokenMap");u(this,"level");u(this,"type");u(this,"delimStr");u(this,"tagStr");u(this,"precise");u(this,"changes",[]);u(this,"selectionShift",{});u(this,"changeSet");u(this,"remappedSelection");if(this.type=e,this.docLen=t.length,this.level=Ve(e)?1:0,this.tagStr=n,this.precise=i.tidyFormatting,this.tokens=o.parser.getTokens(this.level),this.tokenMaps=o.pickMaps(e),this.curTokenMap=this.tokenMaps[this.curSelectionIndex],this.precise){let l=Gi(o.selection,t);this.selectionRanges=l.ranges.map(f=>f)}else this.selectionRanges=o.selection.ranges.map(l=>l);n&&this.level==1?this.tagStr="{"+n+"}":this.level==0&&(this.tagStr+=`
`);let{char:a,length:s}=this.level==1?T[e]:z[e];this.delimStr=a.padEnd(s,a)}get curRange(){return this.selectionRanges[this.curSelectionIndex]}get mappedTokens(){return this.curTokenMap?this.curTokenMap.map(e=>this.tokens[e]):[]}advance(){return this.curSelectionIndex++,this.curSelectionIndex>=this.selectionRanges.length?!1:(this.curTokenMap=this.tokenMaps[this.curSelectionIndex],!0)}pushChange(e){this.changes.push(e)}pushSelectionShift(e,t){this.selectionShift[e]={shift:t}}};var So=class{constructor(e){u(this,"builder");u(this,"mainPlugin");u(this,"formatter");u(this,"root");u(this,"indexCache",{colorMenuItem:{number:0},spanTagMenuItem:{number:0},divTagMenuItem:{number:0}});let t=e.state;this.mainPlugin=t.facet(Kt),this.root=e.root,this.builder=t.field(Pe),this.builder.onViewInit(e),this.formatter=new po(e)}update(e){this.root!==e.view.root&&this.onRootChanged(e.view.root),this.builder.onViewUpdate(e)}destroy(){this.mainPlugin.colorsHandler.abandon(this.root),this.mainPlugin.opacityHandler.abandon(this.root)}onRootChanged(e){this.mainPlugin.colorsHandler.abandon(this.root),this.mainPlugin.opacityHandler.abandon(this.root),this.mainPlugin.colorsHandler.adopt(e),this.mainPlugin.opacityHandler.adopt(e),this.root=e}};var L=be.ViewPlugin.fromClass(So),Vi=[J.of(null),qe,Se,Pe,Hi,L,be.EditorView.decorations.of(r=>{var e,t;return(t=(e=r.plugin(L))==null?void 0:e.builder.holder.blockSet)!=null?t:Ye.RangeSet.empty}),be.EditorView.decorations.of(r=>{var e,t;return(t=(e=r.plugin(L))==null?void 0:e.builder.holder.inlineOmittedSet)!=null?t:Ye.RangeSet.empty}),be.EditorView.decorations.of(r=>{var e,t;return(t=(e=r.plugin(L))==null?void 0:e.builder.holder.colorBtnSet)!=null?t:Ye.RangeSet.empty}),be.EditorView.decorations.of(r=>{var e,t;return(t=(e=r.plugin(L))==null?void 0:e.builder.holder.revealedSpoilerSet)!=null?t:Ye.RangeSet.empty}),be.EditorView.outerDecorations.of(r=>{var e,t;return(t=(e=r.plugin(L))==null?void 0:e.builder.holder.inlineSet)!=null?t:Ye.RangeSet.empty})];var bt=class r{constructor(e,t=document,o){u(this,"stylesheet");u(this,"plugin");u(this,"root");u(this,"subHandlers",[]);var n;let i=(n=t==null?void 0:t.win)!=null?n:t.ownerDocument.win;this.stylesheet=new i.globalThis.CSSStyleSheet,this.plugin=e,this.root=t,this.adoptMain(),o&&this.copy(o)}get rulesLen(){return this.stylesheet.cssRules.length}adoptMain(){this.root.adoptedStyleSheets=[this.stylesheet,...this.root.adoptedStyleSheets]}abandonMain(){let e=this.root.adoptedStyleSheets.filter(t=>t!=this.stylesheet);this.root.adoptedStyleSheets=e,this.subHandlers.forEach(t=>t.destroy()),this.subHandlers=[]}adopt(e){e==this.root||this.subHandlers.find(t=>t.root==this.root)||this.subHandlers.push(new r(void 0,e,this.stylesheet))}abandon(e){e!=this.root&&this.subHandlers.find((t,o)=>{if(t.root==e)return t.destroy(),this.subHandlers.splice(o,1),!0})}destroy(){this.abandonMain(),this.root=void 0,this.stylesheet=void 0,this.plugin&&(this.plugin.colorsHandler=void 0)}insert(e,t=this.rulesLen){return this.subHandlers.forEach(o=>o.insert(e,t)),this.stylesheet.insertRule(e,t)}replace(e,t){this.stylesheet.deleteRule(t),this.stylesheet.insertRule(e,t),this.subHandlers.forEach(o=>o.replace(e,t))}moveSingleRule(e,t){if(t!==1&&t!==-1)throw Error("");if(e<=0&&t<0||e>=this.rulesLen-1&&t>0)return!1;let o=this.stylesheet.cssRules.item(e).cssText;this.stylesheet.deleteRule(e),this.insert(o,e+t),this.subHandlers.forEach(i=>i.moveSingleRule(e,t))}moveRule(e,t){if(e==t)return;let o=Math.max(e,t),i=Math.min(e,t),n=this.stylesheet.cssRules.item(o).cssText;this.removeSingle(o),this.insert(n,i),this.subHandlers.forEach(a=>a.moveRule(e,t))}removeSingle(e){this.stylesheet.deleteRule(e),this.subHandlers.forEach(t=>t.removeSingle(e))}remove(e,t){let o=this.rulesLen;for(let i=Math.min(t,o)-1;i>=e;i--)this.stylesheet.deleteRule(i);this.subHandlers.forEach(i=>i.remove(e,t))}removeAll(){this.stylesheet.replace(""),this.subHandlers.forEach(e=>e.removeAll())}copy(e){for(let t=0;t<e.cssRules.length;t++){let o=e.cssRules.item(t).cssText;this.stylesheet.insertRule(o,t)}}};var fe=require("@codemirror/view"),X=require("@codemirror/view"),Hn=require("@codemirror/state"),je=require("@codemirror/language"),lr=require("@codemirror/commands"),Ui=require("@codemirror/search"),vo=require("@codemirror/autocomplete"),Gn=require("@codemirror/lint");var fr={id:"toggle-insertion",name:"Toggle insertion",icon:"underline",ctxMenuTitle:"Insertion",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(1)},type:1},ur={id:"toggle-spoiler",name:"Toggle spoiler",icon:"rectangle-horizontal",ctxMenuTitle:"Spoiler",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(2)},type:2},cr={id:"toggle-superscript",name:"Toggle superscript",icon:"superscript",ctxMenuTitle:"Superscript",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(3)},type:3},mr={id:"toggle-subscript",name:"Toggle subscript",icon:"subscript",ctxMenuTitle:"Subscript",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(4)},type:4},hr={id:"toggle-custom-highlight",name:"Toggle custom highlight",icon:"highlighter",ctxMenuTitle:"Custom highlight",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(5,void 0,!1,!0)},type:5},dr={id:"toggle-custom-span",name:"Toggle custom span",icon:"brush",ctxMenuTitle:"Custom span",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(6,void 0,!1,!0)},type:6},Wi={id:"toggle-fenced-div",name:"Toggle fenced div",icon:"list-plus",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&t.plugin(L).formatter.startFormat(7,void 0,!1,!0)}},Ki={id:"show-color-menu",name:"Show highlight color menu",icon:"palette",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&q.create(t,5).showMenu()}},qi={id:"show-custom-span-tag-menu",name:"Show custom span tag menu",icon:"shapes",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&q.create(t,6).showMenu()}},Xi={id:"show-fenced-div-tag-menu",name:"Show fenced div tag menu",icon:"shapes",editorCallback:(r,e)=>{let t=r.activeCm||r.cm;t instanceof X.EditorView&&q.create(t,7).showMenu()}};var Yi=[fr,ur,cr,mr,hr,dr,Wi,Ki,qi,Xi],ji=[fr,ur,cr,mr,hr,dr];var zi=require("@codemirror/view"),$i=require("obsidian");function Qi(r,e,t){r.addItem(o=>{let i=o.setSubmenu(),n=e.activeCm||e.cm,a={},s=ji;if(i.onload=function(){$i.Platform.isMobile||i.registerDomEvent(i.dom,"mouseover",()=>{var f;i.currentSubmenu&&i.currentSubmenu!==((f=i.items[i.selected])==null?void 0:f.submenu)&&(i.closeSubmenu(),i.openSubmenuSoon(i.items[i.selected]))})},!(n instanceof zi.EditorView))throw ReferenceError("EditorView not found");n.state.field(Se).iterateSelectedRegion(1,!0,(f,c,m,d)=>{let p=f.type;f.status!=1||a[p]||(d=="covered"||d=="covering")&&(a[p]=!0)}),i.addSections(["selection-extended-inline","selection-extended-block"]),o.setTitle("More format..."),o.setIcon("paintbrush-vertical"),o.setSection("selection");for(let f=0;f<s.length;f++)i.addItem(c=>{let m=s[f].type;if(c.setTitle(s[f].ctxMenuTitle),c.setIcon(s[f].icon),c.setSection("selection-extended-inline"),a[m]&&c.setChecked(!0),m==5||m==6){let d=c.setSubmenu();q.bindMenu(d,n,m)}c.onClick(()=>{s[f].editorCallback(e,t),r.close()})})})}var bo=class extends To.Plugin{constructor(){super(...arguments);u(this,"settings");u(this,"colorsHandler");u(this,"opacityHandler")}async onload(){await this.loadSettings(),this.addSettingTab(new Ut(this.app,this)),Xt(this.settings),this.registerEditorExtension([Wt.of(this.app),Kt.of(this),Be.of(this.settings),Vi]),this.registerMarkdownPostProcessor(new xt(this.settings).postProcess),this.colorsHandler=new bt(this),this.opacityHandler=new bt(this),this.buildColorsStyleSheet(),this.opacityHandler.insert(`body.theme-light{--hl-opacity:${this.settings.lightModeHlOpacity}}`),this.opacityHandler.insert(`body.theme-dark{--hl-opacity:${this.settings.darkModeHlOpacity}}`),this.registerCommands(Yi),this.extendEditorCtxMenu(),console.log("Load Extended Markdown Syntax")}async loadSettings(){this.settings=Object.assign({},Tr(wr),await this.loadData())}async saveSettings(){await this.saveData(this.settings)}onunload(){this.colorsHandler.destroy(),this.opacityHandler.destroy(),console.log("Unload Extended Markdown Syntax")}reconfigureDelimLookup(){ii(this.settings)}refreshMarkdownView(){this.app.workspace.iterateAllLeaves(t=>{let o=t.view;o instanceof To.MarkdownView&&(o.editor.cm.dispatch({annotations:Re.of(!0)}),o.previewMode.rerender(!0))})}buildColorsStyleSheet(t){let o=this.settings.colorConfigs;for(let i=0;i<o.length;i++){let n=Ne(o[i]);this.colorsHandler.insert(n),t&&t(o[i],o)}}setHlOpacity(t,o){let i=o==0?"body.theme-light":"body.theme-dark",n="--hl-opacity",a=o;this.opacityHandler.replace(`${i}{${n}:${t}}`,a)}rebuildColorsStyleSheet(t){this.colorsHandler.removeAll(),this.buildColorsStyleSheet(t)}addNewColor(){let t=this.settings.colorConfigs.length,o=Er("color-"+t,"#ffd000","Color "+t),i=Ne(o);this.settings.colorConfigs.push(o),this.colorsHandler.insert(i,t)}addTagConfig(t){if(Oe(t))if(t==5)this.addNewColor();else{let o=ct(this.settings,t),i=o.length;o.push({name:"Tag "+i,tag:"tag-"+i,showInMenu:!0})}}revertColorConfigs(t){let o=this.settings.colorConfigs;o.splice(0,o.length,...yt()),this.rebuildColorsStyleSheet(t)}revertTagConfigs(t,o){Oe(t)&&(t==5?this.revertColorConfigs(o):ct(this.settings,t).splice(0))}registerCommands(t){t.forEach(o=>this.addCommand(o))}extendEditorCtxMenu(){this.registerEvent(this.app.workspace.on("editor-menu",(t,o,i)=>{Qi(t,o,i)}))}};
/*! Bundled license information:

sortablejs/modular/sortable.esm.js:
  (**!
   * Sortable 1.15.6
   * @author	RubaXa   <trash@rubaxa.org>
   * @author	owenm    <owen23355@gmail.com>
   * @license MIT
   *)
*/

/* nosourcemap */